function t(t,e){var s={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(s[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(t,i[n])&&(s[i[n]]=t[i[n]])}return s}const e=void 0,s={cn:"https://mcs.volceapplog.com",va:"https://mcs.itobsnssdk.com",sg:"https://mcs.tobsnssdk.com"},i={appOnShow:"app_launch",appOnHide:"app_terminate",appOnError:"on_error",pageOnShow:"predefine_pageview",pageOnHide:"predefine_pageview_hide",pageOnShareAppMessage:"on_share",pageOnAddToFavorites:"on_addtofavorites"},n=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],r=["__profile_set","__profile_set_once","__profile_increment","__profile_unset","__profile_append"],o=t=>null!=t&&"[object Object]"==Object.prototype.toString.call(t),a=t=>"function"==typeof t,h=t=>"number"==typeof t&&!isNaN(t),c=()=>+new Date;class p{constructor(t){this.sdk=t,this.env=this.init()}init(){return{user:{web_id:e,user_unique_id:e,user_id:e,user_type:e,user_is_auth:e,user_is_login:e,ip_addr_id:e,device_id:e},header:{app_id:e,app_name:e,app_install_id:e,install_id:e,app_package:e,app_channel:e,app_version:e,os_name:e,os_version:e,device_model:e,device_brand:e,traffic_type:e,client_ip:e,os_api:e,access:e,language:e,app_language:e,creative_id:e,ad_id:e,campaign_id:e,ab_client:e,ab_version:e,platform:e,sdk_version:e,sdk_lib:e,app_region:e,region:e,province:e,city:e,timezone:e,tz_offset:e,tz_name:e,sim_region:e,carrier:e,resolution:e,screen_width:e,screen_height:e,browser:e,browser_version:e,referrer:e,referrer_host:e,utm_source:e,utm_medium:e,utm_campaign:e,utm_term:e,utm_content:e,custom:{},ab_sdk_version:e,_sdk_version:e,_sdk_name:e,wechat_openid:e,wechat_unionid:e}}}set(t){this.sdk.emit(this.sdk.types.EnvTransform,t),Object.keys(t).forEach((e=>{if("evtParams"===e)this.evtParams=Object.assign(Object.assign({},this.evtParams||{}),t.evtParams||{});else if("_staging_flag"===e)this.evtParams=Object.assign(Object.assign({},this.evtParams||{}),{_staging_flag:t._staging_flag});else{let s=e,i=t[e];if(null===i)return!1;let n="";s.indexOf(".")>-1&&([n,s]=s.split(".")),"platform"===s&&(i="mp"),"os_version"!==s&&"mp_platform"!==s||(i=`${i}`),n?("headers"===n&&(n="header"),"user"===n||"header"===n?this.env[n][s]=i:this.env.header.custom[s]=i):this.env.user.hasOwnProperty(s)?["user_type","ip_addr_id"].indexOf(s)>-1?this.env.user[s]=Number(i):["user_id","web_id","user_unique_id"].indexOf(s)>-1?this.env.user[s]=String(i):["user_is_auth","user_is_login"].indexOf(s)>-1?this.env.user[s]=Boolean(i):["device_id"].indexOf(s)>-1&&(this.env.user[s]=i):this.env.header.hasOwnProperty(s)?this.env.header[s]=i:this.env.header.custom[s]=i}}))}get(t){if(!t||"env"===t)return this.clone(this.env);if("evtParams"===t)return Object.assign({},this[t]);if(this.env.hasOwnProperty(t))return this.clone(this.env[t]);if(this.env.user.hasOwnProperty(t))return this.clone(this.env.user[t]);if(this.env.header.hasOwnProperty(t))return this.clone(this.env.header[t]);if(this.env.header.custom.hasOwnProperty(t))return this.clone(this.env.header.custom[t])}compose(t,e=[]){const{user:s,header:i}=this.env,{evtParams:n}=this,r=t.map((t=>(t.event&&!e.includes(t.event)&&n&&Object.keys(n).forEach((e=>{void 0===t.params[e]&&(t.params[e]=n[e])})),t.params=JSON.stringify(t.params),t)));return this.clone({events:r,user:s,header:i})}merge(t,e=[]){const s=this.compose(t,e);return s.local_time=Math.floor(c()/1e3),[s]}clone(t){if(o(t))return JSON.parse(JSON.stringify(t));return t}}class u{constructor(){this.domains=s,this.init()}init(){this.option={caller:"",log:!1,channel:"cn",report_channel:"cn",channel_domain:"",report_url:"",auto_report:false,auto_profile:false,profile_channel:"cn",enable_profile:false,enable_ab_test:false,ab_channel_domain:"",clear_ab_cache_on_user_change:true,enable_et_test:false,event_verify_url:"",enable_buffer:false,buffer_interval:5e3,buffer_number:5,enable_storage_only:false,enable_filter_list:false,enable_third:false,enable_filter_crawler:false,request_timeout:0,enable_initiative_launch:false,enable_custom_webid:false,disable_sdk_monitor:false},this.cloneOption=Object.assign({},this.option),this.initDomain()}initDomain(){if(this.option.channel_domain)return this.domain=this.option.channel_domain,void 0;let t=this.option.report_channel;Object.keys(this.domains).includes(t)||(t="cn"),this.domain=this.domains[t]}set(t){if(!o(t))return;Object.keys(t).forEach((e=>{this.option.hasOwnProperty(e)&&("channel"===e||"report_channel"===e?(this.option.report_channel=this.option.channel=t[e]?t[e]:this.cloneOption[e],this.initDomain()):(this.option[e]=void 0===t[e]?this.cloneOption[e]:t[e],"channel_domain"===e&&this.initDomain()))}))}get(t){if(t){if(this.hasOwnProperty(t))return this[t];if(this.option.hasOwnProperty(t))return this.option[t];return}return Object.assign({},this.option)}}class d{constructor(){this.hooks={}}on(t,e){if(!t||!e||"function"!=typeof e)return;this.hooks[t]||(this.hooks[t]=[]),this.hooks[t].push(e)}once(t,e){if(!t||!e||"function"!=typeof e)return;const s=i=>{e(i),this.off(t,s)};this.on(t,s)}off(t,e){if(!t||!this.hooks[t]||!this.hooks[t].length)return;if(e){const s=this.hooks[t].indexOf(e);-1!==s&&this.hooks[t].splice(s,1)}else this.hooks[t]=[]}emit(t,e){if(!t||!this.hooks[t]||!this.hooks[t].length)return;[...this.hooks[t]].forEach((t=>{try{t(e)}catch(t){}}))}}class l{constructor(t){this.ready=!1,this.sdk=t}setLog(t){t&&a(t.log)&&(this._log=t)}setRequest(t){if(a(t)){const e=t(this.sdk);a(e)&&(this._request=e)}}setStorage(t){o(t)&&a(t.get)&&a(t.set)&&a(t.remove)&&(this._storage=t)}check(){if(!this._request||!this._storage)return;this.ready=!0}log(...t){if(!this._log)return;try{this.sdk.option.get("log")&&this._log.log(...t)}catch(t){}}request(t){var e;if(!this.ready)return Promise.reject();try{return null===(e=this._request)||void 0===e?void 0:e.call(this,t)}catch(t){}}get(t){if(!this.ready)return Promise.reject(null);return this._storage.get(t)}set(t,e){if(!this.ready)return Promise.reject(!1);return this._storage.set(t,e)}remove(t){if(!this.ready)return Promise.reject(!1);return this._storage.remove(t)}}var f;!function(t){t.Init="$init",t.Config="$config",t.Send="$send",t.Ready="$ready",t.TokenComplete="$token-complete",t.TokenStorage="$token-storage",t.TokenFetch="$token-fetch",t.TokenGet="$token-get",t.LaunchComplete="$launch-complete",t.ConfigUuid="$config-uuid",t.ConfigWebId="$config-webid",t.ConfigTransform="$config-transform",t.UuidChangeBefore="$uuid-change-before",t.UuidChangeAfter="$uuid-change-after",t.EnvTransform="$env-transform",t.Event="$event",t.Report="$report",t.AppOpen="$app-open",t.AppClose="$app-close",t.AppShowStart="$app-show-start",t.AppShow="$app-show",t.AppHide="$app-hide",t.AppError="$app-error",t.AppShare="$app-share",t.AppOnShare="$app-on-share",t.PageShow="$page-show",t.PageHide="$page-hide",t.PageShare="$page-share",t.SubmitBefore="$submit-before",t.SubmitAfter="$submit-after",t.SubmitError="$submit-error",t.FilterCrawler="$filter-crawler",t.LaunchInfo="$launch-info",t.AbVar="$ab-var",t.AbAllVars="$ab-all-vars",t.AbExternalVersion="$ab-external-version",t.AbVersionChangeOn="$ab-version-change-on",t.AbVersionChangeOff="$ab-version-change-off",t.AbRefresh="$ab-refresh",t.AbFetchAfter="$ab-fetch-After",t.ProfileSet="$profile-set",t.ProfileSetOnce="$profile-set-once",t.ProfileUnset="$profile-unset",t.ProfileIncrement="$profile-increment",t.ProfileAppend="$profile-append",t.ProfileClear="$profile-clear",t.ProfileSubmitAfter="$profile-submit-after",t.ProfileSubmitError="$profile-submit-error",t.TransformInfo="$transform-info",t.ExtendAppLaunch="$extend-app-launch",t.ExtendAppTerminate="$extend-app-terminate",t.ExtendAppError="$extend-app-error",t.ExtendPageShow="$extend-page-show",t.ExtendPageHide="$extend-page-hide",t.ExtendPageShare="$extend-page-share",t.ExtendPageFavorite="$extend-page-favorite"}(f||(f={}));var g=f,m=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}));class _{constructor(){this.types=g,this.EventType=i,this.ProfileType=r,this.UtmType=n,this.SdkHook=g,this.inited=!1,this.sended=!1,this.pluginInstances=[],this.data=new Map,this.ready=!1,this.sessionId="",this.env=new p(this),this.option=new u,this.hook=new d,_.instances.push(this);try{this.adapter=new l(this),this.adapter.setLog(_._log),this.adapter.setRequest(_._request),this.adapter.setStorage(_._storage),this.adapter.check(),_.plugins.reduce(((t,e)=>{const{plugin:s}=e;return t.push(new s),t}),this.pluginInstances)}catch(t){}}on(t,e){var s;null===(s=this.hook)||void 0===s?void 0:s.on(t,e)}once(t,e){var s;null===(s=this.hook)||void 0===s?void 0:s.once(t,e)}off(t,e){var s;if(!e&&this.types[t])return;null===(s=this.hook)||void 0===s?void 0:s.off(t,e)}emit(t,e){var s;this.adapter.log(`emit ${t}`,e||""),null===(s=this.hook)||void 0===s||s.emit(t,e)}static useAdapterLog(t){_._log=t}static useAdapterRequest(t){_._request=t}static useAdapterStorage(t){_._storage=t}static usePlugin(t,e){const s=e||t.pluginName;if(s){let e=!1;for(let i=0,n=_.plugins.length;i<n;i++){if(_.plugins[i].name===s){_.plugins[i].plugin=t,e=!0;break}}e||_.plugins.push({name:s,plugin:t})}else _.plugins.push({plugin:t});if("function"==typeof t.init)try{t.init(_)}catch(t){}}get appId(){return this._appId}checkUsePlugin(t){return!!_.plugins.find((({name:e})=>e===t))}init(e){if(this.inited||!o(e))return;const{app_id:s,log:i}=e,n=t(e,["app_id","log"]);if(void 0!==i&&this.option.set({log:i}),!(h(s)&&s>0))return this.adapter.log("app_id invalid"),void 0;this._appId=s,this.option.set(n),this.env.set({app_id:s}),Promise.all([new Promise((t=>{this.once(g.TokenComplete,(()=>{t(!0)}))})),new Promise((t=>{this.checkUsePlugin("official:auto")?this.on(g.LaunchComplete,(()=>{t(!0)})):t(!0)})),new Promise((t=>{this.sended?t(!0):this.once(g.Send,(()=>{t(!0)}))}))]).then((()=>{this.ready=!0,this.emit(g.Ready)}));const r=this.option.get();if(this.pluginInstances.forEach((t=>{t.apply(this,r)})),this.get("is-crawler"))return;this.inited=!0,this.emit(g.Init),this.sessionId=m(),this.on(g.AppShowStart,(()=>{this.sessionId=m()}))}config(e){if(!this.inited||!o(e))return;this.emit(g.Config,e);const{web_id:s,user_unique_id:i}=e,n=t(e,["web_id","user_unique_id"]);void 0!==s&&this.emit(g.ConfigWebId,s),void 0!==i&&this.emit(g.ConfigUuid,i),this.env.set(n)}send(){if(!this.inited||this.sended)return;this.sended=!0,this.emit(g.Send)}event(t,e){if(this.get("is-crawler"))return;if(Array.isArray(t)){const e=c(),s=[];t.forEach((t=>{let i,n,r;if(Array.isArray(t)?[i,n,r]=t:o(t)&&(i=t.event,n=t.params,r=t.local_time_ms),!i)return;(!h(r)||r<0||r>e)&&(r=e),s.push(this.createEvent({event:i,params:n,time:r}))})),s.length>0&&this.emit(g.Event,s)}else this.emit(g.Event,this.createEvent({event:t,params:e}))}createEvent(t,e=!0){const s=Object.assign({event:t.event,params:t.params||{},local_time_ms:t.time||c()},this.sessionId?{session_id:this.sessionId}:{});if(!e)return s;let i="";const n=this.get("ab_sdk_version");n&&(i+=n);const r=this.get("ab_sdk_version_external");return r&&(i?i+=","+r:i=r),Object.assign(Object.assign({},s),i?{ab_sdk_version:i}:{})}set(t,e){this.data.set(t,e)}get(t){return this.data.get(t)}getKey(t){const e=this.appId;if("ab_version"===t||"ab_version_external"===t)return`__tea_sdk_${t}_${e}`;const s={token:"tokens",report:"reports",event:"events",utm:"utm",first:"first",compensate:"compensate"};return s[t]?`__tea_cache_${s[t]}_${e}`:void 0}getUrl(t){const{option:e,env:s}=this,i=s.get("_sdk_version"),n=(s.get("_sdk_name")||"").replace(/@.+\//,""),r=`${e.get("domain")}${t}?sdk_version=${i}&sdk_name=${n}`,o=e.get("caller");if(o)return`${r}&app_id=${this.appId}&caller=${o}`;return r}getToken(t){if(t)return this.emit(g.TokenGet,{callback:t}),void 0;return new Promise((t=>{this.emit(g.TokenGet,{callback:e=>{t(e)}})}))}getConfig(t){return this.env.get(t||"header")}stash(t,e={}){const s="stash";this.set(s,[...this.get(s)||[],this.createEvent({event:t,params:e})])}commit(){const t="stash",e=this.get(t)||[];e.length>0&&(this.event(e),this.set(t,[]))}getVar(t,e,s){if(s)return this.emit(g.AbVar,{name:t,defaultValue:e,callback:s}),void 0;return new Promise((s=>{this.emit(g.AbVar,{name:t,defaultValue:e,callback:t=>{s(t)}})}))}getAllVars(t){if(t)return this.emit(g.AbAllVars,t),void 0;return new Promise((t=>{this.emit(g.AbAllVars,(e=>{t(e)}))}))}getAbSdkVersion(){const t=this.get("ab_versions")||[];return t.length>0?t[t.length-1].ab:""}onAbSdkVersionChange(t){return this.emit(g.AbVersionChangeOn,t),()=>{this.emit(g.AbVersionChangeOff,t)}}offAbSdkVersionChange(t){this.emit(g.AbVersionChangeOff,t)}setExternalAbVersion(t){this.emit(g.AbExternalVersion,"string"==typeof t&&t?`${t}`.trim():null)}getAbConfig(t,e){if(e)return this.emit(g.AbRefresh,{params:t,callback:e}),void 0;return new Promise((e=>{this.emit(g.AbRefresh,{params:t,callback:t=>{e(t)}})}))}profileSet(t){this.emit(g.ProfileSet,t)}profileSetOnce(t){this.emit(g.ProfileSetOnce,t)}profileUnset(t){this.emit(g.ProfileUnset,t)}profileIncrement(t){this.emit(g.ProfileIncrement,t)}profileAppend(t){this.emit(g.ProfileAppend,t)}autoInitializationRangers(e){const{onTokenReady:s}=e,i=t(e,["onTokenReady"]);return this.init(Object.assign(Object.assign({},i),{log:!1,enable_third:!0})),this.send(),this.getToken().then((t=>{const{web_id:e}=t;try{if("function"==typeof s)return s(`${e}`),void 0}catch(t){}return`${e}`}))}}_.plugins=[],_.instances=[];class y{apply(t,e){t.env.set({sdk_version:"2.1.2",_sdk_version:"2.1.2",_sdk_name:"@datarangers/sdk-mp"})}}var k;y.pluginName="official:info",function(t){t.Default="default",t.Custom="custom"}(k||(k={}));class b{constructor(t,e){this.wrap=t,this.sdk=e,this.url="/webid/"}storageNoData(){this.fetch()}storageHasData(t){return this.wrap.dataComplete(t)}fetch(){const{adapter:t,appId:e}=this.sdk;t.request({url:this.sdk.getUrl(`${this.url}`),method:"POST",data:{app_id:e,url:"-",user_agent:"-",referer:"-",user_unique_id:""}}).then((e=>{try{const{data:{e:s=-1e4,web_id:i=""}={}}=e;if(0===s)return this.fetchComplete(i),void 0;t.log("parse web_id error",s)}catch(e){t.log("parse web_id error",e)}this.fetchComplete()})).catch((e=>{this.fetchComplete(),t.log("fetch web_id error",e)}))}fetchComplete(t){if(!t)return;this.wrap.webIdComplete(t)}storageComplete(t){if(!t)return this.storageNoData(),void 0;try{if(t[this.wrap.typeKey]===k.Default){const e=this.storageHasData(t);this.wrap.complete(e)}else this.storageNoData()}catch(t){}}}class v{constructor(t,e){this.wrap=t,this.sdk=e,this.sdk.on(this.sdk.types.ConfigWebId,(t=>{t=`${t}`,this.wrap.tokenComplete?this.waitComplete(t):this.waitResolve?this.waitResolve(t):this.tmpWebId=t}))}storageNoData(){this.wait()}storageHasData(t){return this.wrap.dataComplete(t,this.tmpWebId)}wait(){new Promise((t=>{void 0!==this.tmpWebId?(t(this.tmpWebId),this.tmpWebId=void 0):this.waitResolve=t})).then((t=>{this.waitComplete(t)}))}waitComplete(t){this.wrap.webIdComplete(t)}storageComplete(t){if(!t)return this.storageNoData(),void 0;try{if(t[this.wrap.typeKey]===k.Custom){const e=this.storageHasData(t);this.wrap.complete(e)}else this.storageNoData()}catch(t){}}}class O{constructor(){this.tokenComplete=!1,this.tobid="",this.tobidUrl="/tobid/",this.tobidKey="",this.isCustom=!1,this.typeKey="_type_"}apply(t,e){this.sdk=t,this.options=e,this.key=this.sdk.getKey("token"),this.tobidKey="diss".split("").reverse().join(""),this.options.enable_custom_webid?(this.isCustom=!0,this.token=new v(this,this.sdk)):(this.isCustom=!1,this.token=new b(this,this.sdk));const{types:s}=this.sdk;this.sdk.on(s.ConfigUuid,(t=>{this.setUserUniqueId(t)})),this.sdk.on(s.TokenGet,(({callback:t})=>{const e=()=>{this.fetchTobid().then((()=>{const e=this.sdk.env.get("user"),s=Object.assign(Object.assign({},e),{web_id:this.webId,user_unique_id:this.userUniqueId});s[this.tobidKey]=this.tobid,"function"==typeof t&&t(s)}))};this.sdk.ready?e():this.sdk.once(s.Ready,(()=>{e()}))})),this.storage()}storage(){const{adapter:t}=this.sdk;t.get(this.key).then((e=>{if(!o(e)||!e.web_id)return this.storageComplete(null),void 0;e[this.typeKey]&&!e[this.tobidKey]&&e.user_unique_id||(e={web_id:e.web_id,user_unique_id:e.user_unique_id||e.web_id},t.set(this.key,e)),this.storageComplete(e)})).catch((e=>{this.storageComplete(null),t.log("get token error",e)}))}storageComplete(t){this.token.storageComplete(t)}dataComplete(t,e){let s=t.web_id;void 0!==e&&e!==s&&(s=e),this.webId=s;let i=t.web_id===t.user_unique_id?s:t.user_unique_id;return void 0!==this.tmpUserUniqueId&&this.tmpUserUniqueId!==i&&(i=this.tmpUserUniqueId?this.tmpUserUniqueId:s,this.tmpUserUniqueId=void 0),this.userUniqueId=i,s!==t.web_id||i!==t.user_unique_id}webIdComplete(t){this.webId=t,this.tmpUserUniqueId?(this.userUniqueId=this.tmpUserUniqueId,this.tmpUserUniqueId=void 0):this.userUniqueId=t,this.complete(!0)}complete(t=!1){const{types:e}=this.sdk,s={web_id:this.webId,user_unique_id:this.userUniqueId};this.sdk.env.set(s),s[this.typeKey]=this.isCustom?k.Custom:k.Default,t&&this.sdk.adapter.set(this.key,s),this.tokenComplete=!0,this.sdk.emit(e.TokenComplete)}setUserUniqueId(t){const{adapter:e,env:s,types:i}=this.sdk;if(this.tokenComplete){if(this.userUniqueId===t)return;this.sdk.emit(i.UuidChangeBefore),this.userUniqueId=t||this.webId,s.set({user_unique_id:this.userUniqueId});const n={web_id:this.webId,user_unique_id:this.userUniqueId,[this.typeKey]:this.isCustom?k.Custom:k.Default};e.set(this.key,n),this.sdk.emit(i.UuidChangeAfter)}else this.tmpUserUniqueId=t}fetchTobid(){const{adapter:t,appId:e}=this.sdk;return t.request({url:this.sdk.getUrl(`${this.tobidUrl}`),method:"POST",data:{app_id:e,web_id:this.webId,user_unique_id:this.userUniqueId}}).then((t=>{try{const{data:{e:e=-1e4,tobid:s=""}={}}=t;if(0===e)return this.tobid=s,void 0}catch(t){}})).catch((e=>{t.log("fetch tobid error",e)}))}}O.pluginName="official:token";class w{constructor(){this.url="/list/",this.cache=[]}apply(t,e){this.sdk=t,this.options=e,this.key=this.sdk.getKey("report"),this.reportUrl=this.sdk.getUrl(`${this.url}`),this.sdk.set("report_url",this.reportUrl);const{types:s}=this.sdk;this.sdk.on(s.Report,(t=>{if(Array.isArray(t)||(t=[t]),!this.sdk.ready)return t.forEach((t=>this.cache.push(t))),void 0;this.report(t)})),this.sdk.on(s.Ready,(()=>{this.cache.length>0&&(this.report([...this.cache]),this.cache.length=0)}));const{adapter:i}=this.sdk;this.sdk.on(s.AppOpen,(()=>{i.get(this.key).then((()=>{}))})),this.sdk.on(s.AppClose,(()=>{this.cache.length>0&&(i.set(this.key,[...this.cache]),this.cache.length=0)}))}report(t){this.submit(t)}submit(t){const{types:e}=this.sdk;this.sdk.emit(e.SubmitBefore,t),this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:t}).then((s=>{this.sdk.emit(e.SubmitAfter,{isError:!1,response:s,event:t})})).catch((s=>{this.sdk.emit(e.SubmitAfter,{isError:!0,error:s,event:t}),this.sdk.emit(e.SubmitError,{event:t})}))}}w.pluginName="official:report";class P{constructor(){this.buffer=[],this.timer=0,this.unReadyCache=[]}apply(t,e){var s,i;this.sdk=t,this.options=e,this.enable=!!this.options.enable_buffer;const n=!0===this.options.enable_storage||!1===this.options.disable_storage;if(n&&(this.enable=!0),this.enable){this.interval=this.options.buffer_interval,this.number=this.options.buffer_number,n&&((null===(s=this.options)||void 0===s?void 0:s.report_interval)>0&&(this.interval=this.options.report_interval),(null===(i=this.options)||void 0===i?void 0:i.max_batch_event)>0&&(this.number=this.options.max_batch_event));try{this.interval=Number(this.interval),this.number=Number(this.number)}catch(t){}}this.sdk.set("enable_storage",this.enable);const{types:r}=this.sdk;this.sdk.on(r.Event,(t=>{if(!this.sdk.ready)return this.unReadyCache=[...this.unReadyCache,...Array.isArray(t)?t:[t]],void 0;this.process(Array.isArray(t)?t:[t])})),this.sdk.on(r.Ready,(()=>{this.unReadyCache.length>0&&(this.process(this.unReadyCache),this.unReadyCache=[])})),this.sdk.on(r.AppClose,(()=>{this.buffer.length>0&&(this.report(this.buffer),this.buffer.length=0)}))}process(t){const e=this.sdk.env.compose(t);if(!this.enable)return this.report(e),void 0;this.buffer=[...this.buffer,e],this.refresh()}refresh(){this.timer&&clearTimeout(this.timer),this.buffer.length>=this.number?(this.report([...this.buffer]),this.buffer.length=0):this.timer=setTimeout((()=>{this.report([...this.buffer]),this.buffer.length=0}),this.interval)}report(t){this.sdk.emit(this.sdk.types.Report,t)}}P.pluginName="official:buffer";class S{apply(t,e){this.sdk=t,this.options=e;const{types:s,env:i}=this.sdk,n=(()=>{try{const t=(new Date).getTimezoneOffset();return{timezone:Math.floor(Math.abs(t)/60),offset:60*t}}catch(t){return{timezone:8,offset:-28800}}})();i.set({timezone:n.timezone,tz_offset:n.offset}),this.sdk.on(s.ConfigTransform,(t=>{void 0!==t.gender&&([1,2,"1","2"].includes(t.gender)?t.gender=t.gender<2?"male":"female":delete t.gender);if(!!this.options.enable_profile){const e={};["nick_name","gender","avatar_url"].forEach((s=>{void 0!==t[s]&&(e[s]=t[s],delete t[s])})),this.sdk.emit(s.ProfileSet,e)}})),this.sdk.on(s.EnvTransform,(t=>{if(!!this.options.enable_profile){const e={};["$mp_from_uuid"].forEach((s=>{void 0!==t[s]&&(e[s]=t[s],delete t[s])})),Object.keys(e).length>0&&this.sdk.emit(s.ProfileSetOnce,e)}}))}}S.pluginName="official:transform";class A{constructor(){this.url="/profile/list",this.lastId=0,this.lastOnceId=0,this.duration=6e4,this.cache={},this.buffer=[]}apply(t,e){this.sdk=t,this.options=e;const{types:s}=this.sdk;this.sdk.on(s.ProfileSet,(t=>{this.check()&&this.setProfile(t)})),this.sdk.on(s.ProfileSetOnce,(t=>{this.check()&&this.setOnceProfile(t)})),this.sdk.on(s.ProfileUnset,(t=>{this.check()&&this.unsetProfile(t)})),this.sdk.on(s.ProfileIncrement,(t=>{this.check()&&this.incrementProfile(t)})),this.sdk.on(s.ProfileAppend,(t=>{this.check()&&this.appendProfile(t)})),this.sdk.on(s.ProfileClear,(()=>{this.cache={}})),this.sdk.on(s.Ready,(()=>{if(!this.buffer.length)return;this.reportMore([...this.buffer]),this.buffer=[]}))}check(){return!!this.options.enable_profile}setProfile(t){const e=this.debounce(t);if(!e)return;this.putCache(e);const s=this.filter(e,(t=>this.isString(t)||this.isNumber(t)||this.isArray(t)));this.report(this.sdk.createEvent({event:"__profile_set",params:s}))}setOnceProfile(t){const e=this.debounce(t,!0);if(!e)return;this.putCache(e);const s=this.filter(e,(t=>this.isString(t)||this.isNumber(t)||this.isArray(t)));this.report(this.sdk.createEvent({event:"__profile_set_once",params:s}))}incrementProfile(t){if(!t)return;const e=this.filter(t,(t=>this.isNumber(t)));this.report(this.sdk.createEvent({event:"__profile_increment",params:e}))}unsetProfile(t){if(!t||!this.isString(t))return;const e={};e[t]="1",this.report(this.sdk.createEvent({event:"__profile_unset",params:e}))}appendProfile(t){if(!t||!this.isObject(t)||this.isEmpty(t))return;const e=this.filter(t,(t=>this.isString(t)||this.isArray(t)));this.report(this.sdk.createEvent({event:"__profile_append",params:e}))}reportMore(t){if(this.sdk.ready){const e=this.sdk.env.merge(t,this.sdk.ProfileType),{adapter:s,option:i}=this.sdk;s.request({url:`${i.get("domain")}${this.url}`,method:"POST",data:e}).then((t=>{this.sdk.emit(this.sdk.types.ProfileSubmitAfter,{isError:!0,response:t,event:e})})).catch((t=>{this.sdk.emit(this.sdk.types.ProfileSubmitError,{isError:!0,error:t,event:e})}))}else t.forEach((t=>{this.buffer.push(t)}))}report(t){this.reportMore([t])}ms(){return c()}debounce(t,e=!1){if(!t||!this.isObject(t)||this.isEmpty(t))return;let s=Object.keys(t);const i=this.ms(),n=s.filter((s=>{const n=this.cache[s];if(n&&(e||this.compare(n.val,t[s])&&i-n.timestamp<this.duration))return!1;return!0})).reduce(((e,s)=>(e[s]=t[s],e)),{});if(s=Object.keys(n),!s.length)return;return n}putCache(t){const e=this.ms();Object.keys(t).forEach((s=>{this.cache[s]={val:this.clone(t[s]),timestamp:e}}))}clone(t){try{return JSON.parse(JSON.stringify(t))}catch(e){return t}}compare(t,e){return JSON.stringify(t)===JSON.stringify(e)}filter(t,e){return Object.keys(t).reduce(((s,i)=>{const n=t[i];return e(n)&&(s[i]=n),s}),{})}isObject(t){return o(t)}isArray(t){return(t=>"function"==typeof Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t))(t)}isNumber(t){return h(t)}isString(t){return(t=>"string"==typeof t)(t)}isEmpty(t){return!Object.keys(t).length}}function I(t){let e=0,s=0;const i=(t+="").length;for(let n=0;n<i;n++)e=31*e+t.charCodeAt(s++),(e>0x7fffffffffff||e<-0x800000000000)&&(e&=0xffffffffffff);return e<0&&(e+=0x7ffffffffffff),e}A.pluginName="official:profile";const C=t=>{let e=t;try{e=decodeURIComponent(t)}catch(t){}return e},x=t=>{const e={};return t&&t.split("&").forEach((t=>{if(t){const s=t.split("=");s[0]&&(e[s[0]]=s[1]||"")}})),e};_.usePlugin(y),_.usePlugin(O),_.usePlugin(w),_.usePlugin(P),_.usePlugin(S),_.usePlugin(A);class E extends _{appLaunch(){this.appShow()}appTerminate(){this.appHide()}appShow(){let t;void 0!==this.target.getLaunchOptionsSync&&(t=this.target.getLaunchOptionsSync()),this.emit(this.types.AppShow,t)}appHide(){this.emit(this.types.AppHide)}appError(t){this.emit(this.types.AppError,t)}predefinePageview(){this.emit(this.types.PageShow)}predefinePageviewHide(){this.emit(this.types.PageHide)}shareAppMessage(t){try{const e=this.pluginInstances.find((t=>"official:auto"===t.constructor.pluginName));if(e&&"function"==typeof e.pageShare)return e.pageShare(t)}catch(t){}return t}setWebIDviaUnionID(t){if(!t||!this.option.get("enable_custom_webid"))return;const e=I(String(t).trim());this.config({web_id:e,wechat_unionid:t})}setWebIDviaOpenID(t){if(!t||!this.option.get("enable_custom_webid"))return;const e=I(String(t).trim());this.config({web_id:e,wechat_openid:t})}createWebViewUrl(t){if(!t||!this.ready)return t;const e=this.env.get("web_id");if(!e)return t;return this.processWebViewUrl(t,e)}createWebViewUrlAsync(t){if(!t)return Promise.resolve(t);return this.ready?Promise.resolve(this.processWebViewUrl(t,this.env.get("web_id"))):new Promise((e=>{this.on(this.types.Ready,(()=>{e(this.processWebViewUrl(t,this.env.get("web_id")))}))}))}processWebViewUrl(t,e){t=C(t);const s=/([^?#]+)(\?[^#]*)?(#.*)?/.exec(t),i=s[1]||"",n=s[2]||"",r=s[3]||"",o=n?x(n.substring(1)):{};return o.Web_ID=e,t=i+((t,e)=>{let s=t;if(e){const t=[];Object.keys(e).forEach((s=>{t.push(`${s}=${e[s]}`)})),t.length>0&&(s+=`?${t.join("&")}`)}return s})("",o)+r,t}}var j=console;let q="undefined";const $=()=>{if("undefined"!==q)return q;return q="undefined"!=typeof tt?{target:tt,config:"undefined"!=typeof __ttConfig?__ttConfig:null,customPlatform:"ttMiniProduct",mpPlatform:2,is:"tt"}:"undefined"!=typeof my?{target:my,config:null,customPlatform:"aliMiniProduct",mpPlatform:1,is:"my"}:"undefined"!=typeof swan?{target:swan,config:null,customPlatform:"swanMiniProduct",mpPlatform:5,is:"swan"}:"undefined"!=typeof qq?{target:qq,config:"undefined"!=typeof __qqConfig?__qqConfig:null,customPlatform:"qqMiniProduct",mpPlatform:6,is:"qq"}:"undefined"!=typeof wx?{target:wx,config:"undefined"!=typeof __wxConfig?__wxConfig:null,customPlatform:"miniProduct",mpPlatform:0,is:"wx"}:"undefined"!=typeof uni?{target:uni,config:null,customPlatform:"uniMiniProduct",mpPlatform:7,is:"uni"}:{target:{},config:null,customPlatform:"",mpPlatform:-1,is:""},q},U=$();var T="my"===U.is?t=>e=>{const s=e.timeout||t.option.get("request_timeout"),i="number"==typeof s&&s>0;return new Promise(((t,n)=>{const r=my[my.request?"request":"httpRequest"](Object.assign(Object.assign({},e),{dataType:e.dataType||"json",success:e=>{t(e)},fail:t=>{n(t)}}));i&&setTimeout((()=>{try{r&&r.abort()}catch(t){}}),s)}))}:U.target?((t,e=!1)=>s=>i=>{const n=i.timeout||s.option.get("request_timeout"),r="number"==typeof n&&n>0;return new Promise(((s,o)=>{const a=t.request(Object.assign(Object.assign(Object.assign({},i),r&&!e?{timeout:n}:{}),{dataType:i.dataType||"json",success:t=>{s(t)},fail:t=>{o(t)}}));r&&e&&setTimeout((()=>{try{a&&a.abort()}catch(t){}}),n)}))})(U.target,"swan"===U.is):t=>t=>Promise.reject("request adapter error");const N=$();var V="my"===N.is?new class{get(t){return new Promise(((e,s)=>{try{e(my.getStorageSync({key:t}).data)}catch(t){s(t)}}))}set(t,e){return new Promise(((s,i)=>{try{my.setStorageSync({key:t,data:e}),s(!0)}catch(t){i(!1)}}))}remove(t){return new Promise(((e,s)=>{try{my.removeStorageSync({key:t}),e(!0)}catch(t){s(!1)}}))}}:N.target?new class{constructor(t){this.target=t}get(t){return new Promise(((e,s)=>{try{e(this.target.getStorageSync(t))}catch(t){s(t)}}))}set(t,e){return new Promise(((s,i)=>{try{this.target.setStorageSync(t,e),s(!0)}catch(t){i(!1)}}))}remove(t){return new Promise(((e,s)=>{try{this.target.removeStorageSync(t),e(!0)}catch(t){s(!1)}}))}}(N.target):(()=>{const t="storage adapter error";return{get:e=>Promise.reject(t),set:(e,s)=>Promise.reject(t),remove:e=>Promise.reject(t)}})();class L{apply(t,e){this.sdk=t,this.options=e,this.boost();const{types:s}=this.sdk;this.getInfo(),this.sdk.on(s.AppOpen,(()=>{this.getInfo()}))}boost(){}getInfo(){const t=this,{target:e,env:s}=this.sdk;e&&(e.getSystemInfo&&e.getSystemInfo({success(e){const i={device_brand:e.brand,device_model:e.model,os_version:e.system,os_name:e.platform,platform:e.platform,resolution:`${e.screenWidth}x${e.screenHeight}`,screen_width:e.screenWidth,screen_height:e.screenHeight};t.overlap(e,i),s.set(i)}}),e.getNetworkType&&e.getNetworkType({success(t){const e={access:t.networkType};s.set(e)}}))}overlap(t,e){e.language=t.language,e.mp_platform_app_version=t.version,e.mp_platform_basic_version=t.SDKVersion}}L.pluginName="official:device";E.useAdapterLog(j),E.useAdapterRequest(T),E.useAdapterStorage(V),E.usePlugin(class extends L{static init(t){const e=$();t.platform=e.is?e.target:null,t.platformIs=e.is}boost(){super.boost(),this.which=$(),this.sdk.target=this.which.target,this.sdk.targetEnvConfig=this.which.config,this.sdk.env.set({sdk_lib:"mp_common",custom_platform:this.which.customPlatform,mp_platform:this.which.mpPlatform})}overlap(t,e){super.overlap(t,e)}});class R{constructor(){this.scenes=[1129]}apply(t,e){if(this.sdk=t,this.options=e,!this.options.enable_filter_crawler)return;const{target:s,types:i}=this.sdk,n=t=>{this.scenes.includes(null==t?void 0:t.scene)&&this.sdk.set("is-crawler",!0)};try{if(s.getLaunchOptionsSync){const t=s.getLaunchOptionsSync();n(t)}}catch(t){}this.sdk.on(i.AppOpen,(t=>{n(t)}))}}R.pluginName="official:robot";class H{constructor(){this.key="start_rangers_data_check",this.buffer=[],this.test=!1,this.testRequestNumber=0,this.interval=1e3,this.needOn=!1,this.onHandler=()=>{}}apply(t,e){this.sdk=t,this.options=e;const{types:s}=this.sdk;this.sdk.once(s.AppOpen,(t=>{try{if(this.host=t,t.getLaunchOptionsSync){const e=t.getLaunchOptionsSync(),{query:i}=e;this.verify(i).then((()=>{this.needOn=!0,this.onHandler=t=>{this.submit(t)},this.sdk.on(s.Event,this.onHandler)}))}}catch(t){}})),this.sdk.on(s.AppClose,(()=>{this.needOn&&(this.userInfo=null,this.sdk.off(s.Event,this.onHandler),this.onHandler=()=>{},this.needOn=!1)}))}check(t){var e;return null!==(e=null==t?void 0:t[this.key])&&void 0!==e?e:""}verify(t){const{adapter:e}=this.sdk;let s;const i=new Promise((t=>{s=t})),n=t=>{s(!0),this.userInfo=t||{nickName:"未知",avatarUrl:""},e.log(`verify open ${JSON.stringify(this.userInfo)}`),this.login()},r=this.check(t);if(e.log(`verify ${r}`),r){try{const t=(t=>{const e=e=>{return(s=t,s.split("").map((t=>t.charCodeAt(0)))).reduce(((t,e)=>t^e),e);var s};return t=>t.match(/.{1,2}/g).map((t=>parseInt(t,16))).map(e).map((t=>String.fromCharCode(t))).join("")})("logverify")(r);t&&/^https?:\/\//.test(t)&&(this.domain=t),e.log(`verify domain ${t}`)}catch(t){}this.host.getSetting({success(t){e.log("getSetting success"),t.authSetting["scope.userInfo"]?(e.log("getSetting scope.userInfo success"),this.host.getUserInfo?this.host.getUserInfo({success(t){e.log("getUserInfo success");const{nickName:s,avatarUrl:i}=t.userInfo;n({nickName:s,avatarUrl:i})},fail(){e.log("getUserInfo fail"),n()}}):this.host.getOpenUserInfo&&this.host.getOpenUserInfo({success(t){e.log("getUserInfo success");try{const e=JSON.parse(t.response).response,{nickName:s,avatar:i}=e;n({nickName:s,avatarUrl:i})}catch(t){}},fail(){e.log("getUserInfo fail"),n()}})):(e.log("getSetting scope.userInfo fail"),n())},fail(){e.log("getSetting fail"),n()}})}return i}submit(t){try{this.pushBuffer(JSON.parse(JSON.stringify(t)))}catch(t){}}login(){if(!this.domain)return;const{header:t}=this.prepareHeader();this.sdk.adapter.request({url:`${this.domain}/simulator/limited_mobile/try_link`,method:"POST",data:Object.assign(Object.assign({header:Object.assign(Object.assign({},t||{}),{aid:t.app_id})},this.userInfo?{nick_name:this.userInfo.nickName}:{}),{host_version:(t.custom||{}).mp_platform_app_version||"",sync_id:this.syncId||""})}).then((t=>{try{const{data:{data:{retry:e,sync_id:s,token:i}}}=t;if(this.syncId=s,this.token=i,this.test&&this.testRequestNumber>3)return this.report(),void 0;0===e||(1===e?this.loginLoop():2===e&&this.report())}catch(t){this.loginLoop()}})).catch((()=>{this.loginLoop()}))}loginLoop(){this.test&&this.testRequestNumber++,setTimeout((()=>{this.login()}),this.interval)}report(){if(!this.domain)return;const{header:t}=this.prepareHeader(),e=this.buffer;this.buffer=[],this.sdk.adapter.request({url:`${this.domain}/simulator/limited_mobile/log`,method:"POST",data:{header:Object.assign(Object.assign({},t||{}),{aid:t.app_id}),token:this.token||"",event_v3:e||[]}}).then((t=>{try{const{data:{data:{keep:e}}}=t;!0===e?this.reportLoop():this.reset()}catch(t){this.reportLoop()}})).catch((()=>{this.reportLoop()}))}reportLoop(){setTimeout((()=>{this.report()}),this.interval)}pushBuffer(t){(Array.isArray(t)?[...t]:[t]).forEach((t=>{if("string"==typeof t.params)try{t.params=JSON.parse(t.params)}catch(t){}this.buffer.push(t)}))}prepareHeader(){const{env:t}=this.sdk,{user:e,header:s}=t.get();return JSON.parse(JSON.stringify({user:e,header:s}))}reset(){this.buffer=[],this.syncId="",this.token=""}}H.pluginName="official:verify";const D={cn:"https://abtest.volceapplog.com",va:"https://toblog.itobsnssdk.com",sg:"https://toblog.tobsnssdk.com"};class M{constructor(){this.expire=2592e6,this.domains=D,this.url="/service/2/abtest_config/",this.message={cb:"回调函数必须为一个函数",var:"变量名不能为空",value:"变量没有默认值"},this.fetchStatus=0,this.callbacks=[],this.data=null,this.versions=[],this.externalVersions=null,this.hasOn=!1,this.onHandler=()=>{},this.changeListener=new Map,this.exposureName="abtest_exposure",this.clear=!1}apply(t,e){this.sdk=t,this.options=e;const{adapter:s,types:i,appId:n}=this.sdk;if(this.appId=n,this.externalKey=this.sdk.getKey("ab_version_external"),this.sdk.on(i.AbExternalVersion,(t=>{this.processExternal(t);const{adapter:e}=this.sdk;t?e.set(this.externalKey,t):e.remove(this.externalKey)})),s.get(this.externalKey).then((t=>{if(!t)return;try{this.processExternal(t)}catch(t){}})),!this.options.enable_ab_test)return;this.dataKey=this.sdk.getKey("ab_version"),this.clear=this.options.clear_ab_cache_on_user_change,this.domain=this.getDomain(),this.sdk.on(i.UuidChangeAfter,(()=>{if(!this.sdk.ready)return;this.clear&&(this.versions=[],this.data={},this.updateVersions(),this.emitChange())})),this.sdk.once(i.Ready,(()=>{this.preFetch(),this.sdk.on(i.UuidChangeAfter,(()=>{this.preFetch()}))})),this.sdk.on(i.AbVar,(({name:t,defaultValue:e,callback:s})=>{this.getVar(t,e,s)})),this.sdk.on(i.AbAllVars,(t=>{this.getAllVars(t)})),this.sdk.on(i.AbVersionChangeOn,(t=>{this.changeListener.set(t,t)})),this.sdk.on(i.AbVersionChangeOff,(t=>{this.changeListener.get(t)&&this.changeListener.delete(t)})),this.sdk.on(i.AbRefresh,(({params:t,callback:e})=>{this.preFetch(t,e)})),s.get(this.dataKey).then((t=>{if(!t)return;const e=t.timestamp;if(c()-e>=this.expire)return this.sdk.adapter.remove(this.dataKey),void 0;try{const{ab_version:e,data:s}=t;2!==this.fetchStatus&&(this.versions=e||[],this.data=s,this.configVersions())}catch(t){}}))}output(t){this.sdk.adapter.log(t)}processExternal(t){this.externalVersions=t,this.sdk.set("ab_sdk_version_external",t)}getAllVars(t){if("function"!=typeof t)return this.output(this.message.cb);const e={callback:t,type:1};2===this.fetchStatus?this._getAllVars(e):this.callbacks.push(e)}getVar(t,e,s){if(!t)return this.output(this.message.var);if(void 0===e)return this.output(this.message.value);if("function"!=typeof s)return this.output(this.message.cb);const i={name:t,defaultValue:e,callback:t=>{try{s(t)}catch(t){}},type:0};2===this.fetchStatus?this._getVar(i):this.callbacks.push(i)}fetchComplete(t){if(t){this.data=t;const e=[];Object.keys(t).forEach((s=>{const{vid:i}=t[s];i&&e.push(i)}));const s=this.versions.length;s?(this.versions=this.versions.filter((t=>e.includes(t))),this.versions.length!==s&&this.updateVersions()):this.updateVersions()}this.callbacks.forEach((t=>this[0===t.type?"_getVar":"_getAllVars"](t))),this.callbacks=[]}_getAllVars(t){const{callback:e}=t;e(this.data?JSON.parse(JSON.stringify(this.data)):{})}_getVar(t){const{name:e,defaultValue:s,callback:i}=t,{data:n}=this;if(!n)return i(s),void 0;if(o(n[e])){const{vid:t,val:s}=n[e];return t&&(this.versions.includes(t)||(this.versions.push(t),this.updateVersions(),this.emitChange()),this.sdk.emit(this.sdk.types.Event,Object.assign(Object.assign({},this.sdk.createEvent({event:this.exposureName},!1)),{ab_sdk_version:t}))),i(s),void 0}i(s)}updateVersions(){this.configVersions(),this.sdk.adapter.set(this.dataKey,{data:this.data,ab_version:this.versions,timestamp:c()})}configVersions(){const t=this.versions.join(",");this.sdk.set("ab_sdk_version",t);const e="ab_versions";this.sdk.set(e,[...this.sdk.get(e)||[],{time:c(),ab:t}])}emitChange(){const t=this.versions.join(",");this.changeListener.size>0&&this.changeListener.forEach((e=>{"function"==typeof e&&setTimeout((()=>{try{e(t)}catch(t){}}),0)}))}getDomain(){var t;const{channel_domain:e,ab_channel_domain:s}=this.options,{option:i}=this.sdk,n=null===(t=i.get("cloneOption"))||void 0===t?void 0:t.report_channel;let r="";if(s)r=s;else if(e)r=e;else{let{report_channel:t}=this.options;Object.keys(this.domains).includes(t)||(t=n),r=this.domains[t]}return r}preFetch(e={},s){if(!this.domain)return this.fetchStatus=2,this.fetchComplete(null),s&&s(null),void 0;const{env:i}=this.sdk,{user:n,header:r}=i.get(),{headers:o}=r,a=t(r,["headers"]);this.user=Object.assign({},n),this.fetch(Object.assign(Object.assign(Object.assign({},a),o),e||{})).then((t=>s&&s(t)))}fetch(t){this.fetchStatus=1;const{user_unique_id:e}=this.user;return this.sdk.adapter.request({url:`${this.domain}${this.url}`,method:"POST",data:{header:Object.assign(Object.assign({aid:this.appId},this.user||{}),t||{})}}).then((t=>{var s;if(this.user.user_unique_id!==e)return null;this.fetchStatus=2;const i=null===(s=null==t?void 0:t.data)||void 0===s?void 0:s.data;return this.sdk.emit(this.sdk.types.AbFetchAfter,i),this.fetchComplete(i),i})).catch((()=>(this.fetchStatus=2,this.fetchComplete(null),null)))}}M.pluginName="official:ab";class K{constructor(){this.key="utm"}apply(t,e){this.sdk=t,this.options=e;const{types:s}=this.sdk;this.sdk.on(s.LaunchInfo,(t=>{var e,s;this.parseDefault(null!==(e=null==t?void 0:t.query)&&void 0!==e?e:{}),this.parseMore(null!==(s=null==t?void 0:t.query)&&void 0!==s?s:{})}))}parseDefault(t={}){let e=!1;const s=Object.keys(t).reduce(((s,i)=>(this.sdk.UtmType.includes(i)&&(e=!0,s[i]=C(t[i])),s)),{});e&&this.sdk.env.set(s)}parseMore(t={}){const{tr_token:e="",surl_token:s="",scene:i=""}=t||{};let n=e||s;if(i){const t=x(C(`${i}`));t.tr_token&&(n=t.tr_token),this.sdk.set("scene_extra_query",t)}if(!n)return this.dispatch(),void 0;this.storageGet(n).then((t=>{t?(this.sdk.env.set(t.utms||{}),this.dispatch()):this.fetch(n).then((()=>this.dispatch())).catch((()=>this.dispatch()))})).catch((()=>{this.fetch(n).then((()=>this.dispatch())).catch((()=>this.dispatch()))}))}storageGet(t){const e=this.sdk.getKey(this.key),{adapter:s}=this.sdk;return s.get(e).then((i=>{const n=c(),r=[];if(Object.keys(i).forEach((t=>{i[t]&&i[t].timestamp+864e7<n&&r.push(t)})),r.length>0&&(r.forEach((t=>{delete i[t]})),s.set(e,i)),i&&i[t])return i[t];return null}))}storageSet(t,e){const s=this.sdk.getKey(this.key),{adapter:i}=this.sdk;i.get(s).then((n=>{n||(n={}),n[t]={utms:e,timestamp:c()},i.set(s,n)}))}fetch(t){const{adapter:e,option:s,env:i,UtmType:n}=this.sdk;return e.request({url:`${s.get("domain")}/service/2/mp_campaigns`,method:"GET",data:{tr_token:t},timeout:3e3}).then((s=>{const{data:{code:r=-1,data:a={},message:h=""}={}}=s||{};if(0===r){if(o(a)){let e=!1;const s=Object.keys(a).reduce(((t,i)=>(n.includes(i)&&(e=!0,s[i]=a[i]),t)),{});e&&i.set(s),this.storageSet(t,s)}}else 40002===r&&this.storageSet(t,{});0!==r&&e.log(h||"")}))}dispatch(){this.sdk.emit(this.sdk.types.LaunchComplete)}}K.pluginName="official:utm";class F{constructor(){this.key="compensate",this.cache=new Map,this.batchMax=10,this.enable=!1,this.storageCache=new Map}apply(t,e){this.sdk=t,this.options=e,this.reportUrl=this.sdk.get("report_url"),this.enable=this.sdk.get("enable_storage"),this.options.enable_storage_only&&(this.enable=!0);const{types:s}=this.sdk;this.enable&&this.sdk.on(s.Ready,(()=>{this.storageGet().then((t=>{if(!this.reportUrl||!t||!Array.isArray(t))return;const e=t=>new Promise((e=>{this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:t}).then((()=>{e(null)})).catch((()=>{e(null)}))}));if(t.length>50){const s=[...t],i=()=>{const t=s.splice(0,50);t.length>0&&e(t).then((()=>{s.length>0&&i()}))};i()}else e(t)}))})),this.sdk.on(s.SubmitError,(t=>{const e=this.random(),{event:s}=t;this.cache.set(e,s),this.process()})),this.sdk.on(s.AppClose,(()=>{this.report()}))}process(){this.cache.size>=this.batchMax&&this.report()}report(){if(!this.reportUrl&&(this.reportUrl=this.sdk.get("report_url"),!this.reportUrl))return;let t=[];if(this.cache.forEach((e=>{t=[...t,...e]})),t.length>0){const e=this.random();this.enable&&this.storageCache.set(e,t),this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:t}).then((()=>{this.enable&&this.storageCache.delete(e)})).catch((()=>{if(this.enable){let t=[];this.storageCache.forEach((e=>{t=[...t,...e]})),this.storageSet(t)}})),this.cache=new Map}}storageGet(){const t=this.sdk.getKey(this.key),{adapter:e}=this.sdk;return e.get(t).then((s=>{if(e.remove(t),!o(s)||!s.timestamp)return null;const i=c();if(s.timestamp+864e7<i)return null;return s.data}))}storageSet(t){const e=this.sdk.getKey(this.key),{adapter:s}=this.sdk;s.set(e,{data:t,timestamp:c()})}random(){return`${+new Date}_${Math.floor(1e10*Math.random())}`}}F.pluginName="official:compensate";class J{apply(t,e){this.sdk=t,this.options=e;const{types:s}=this.sdk;this.options.disable_sdk_monitor||this.options.channel_domain||this.sdk.on(s.Ready,(()=>{this.reportLoad()}))}reportLoad(){const t=this.sdk.env.get(),{user:e,header:s}=t,i=this.sdk.env.merge([{event:"onload",params:Object.assign(Object.assign(Object.assign({},e),s),this.options)}]);i[0].header.app_id=1338,this.report(i)}report(t){if(!this.reportUrl){let t=this.sdk.get("report_url");if(!t)return;t+=(t.indexOf("?")?"&":"?")+"type=monitor",this.reportUrl=t}this.sdk.adapter.request({url:this.reportUrl,method:"POST",header:{"X-MCS-AppKey":"566f58151b0ed37e"},data:t})}}J.pluginName="official:monitor";const W="mp_launch",B="mp_enter",z="mp_exit",G="purchase",Q="query",X="update_level",Y="create_gamerole",Z="check_out",et="add_to_favourite";let st;const it={mpLaunch:(t,e)=>{t(W,Object.assign({},e))},mpEnter:(t,e)=>{st=+new Date,t(B,Object.assign({},e))},mpExit:(t,e={})=>{const s=getCurrentPages(),i=s[s.length-1].route,n=void 0===st?0:+new Date-st;t(z,Object.assign({duration:n,page_path:i},e)),st=void 0},purchase:(t,e)=>{t(G,Object.assign({},e))},quest:(t,e)=>{t(Q,Object.assign({},e))},updateLevel:(t,e)=>{t(X,Object.assign({},e))},createGameRole:(t,e)=>{t(Y,Object.assign({},e))},checkout:(t,e)=>{t(Z,Object.assign({},e))},addToFavourite:(t,e)=>{t(et,Object.assign({},e))}};class nt{apply(t,e){this.sdk=t,this.options=e,Object.keys(it).forEach((t=>{this.sdk[t]=it[t].bind(null,this.sdk.event.bind(this.sdk))}))}}var rt;nt.pluginName="official:extend",function(t){t.True="true",t.False="false"}(rt||(rt={}));class ot{constructor(){this.queue=[],this.firstTime=rt.False,this.open=!1,this.launched=!1,this.autoConfig={appLaunch:!0,appTerminate:!0,appError:!0,pageShow:!0,pageHide:!0,pageShare:!0,pageFavorite:!0},this.missAppLaunch=!1,this.missAppShow=!1,ot.instances.push(this)}static init(t){const e={onLaunch(e){t.instances.forEach((t=>{t.emit(t.types.AppOpen,e)})),ot.instances.forEach((t=>{t.sdk||(t.missAppLaunch=!0,t.missAppLaunchInfo=e)}))},onShow(e){t.instances.forEach((t=>{t.emit(t.types.AppShowStart,e),t.emit(t.types.AppShow,e)})),ot.instances.forEach((t=>{t.sdk||(t.missAppShow=!0,t.missAppShowInfo=e)}))},onHide(){t.instances.forEach((t=>{t.emit(t.types.AppHide),t.emit(t.types.AppClose)}))},onError(e){t.instances.forEach((t=>{t.emit(t.types.AppError,e)}))}},s={onShow(){t.instances.forEach((t=>{t.emit(t.types.PageShow)}))},onHide(){t.instances.forEach((t=>{t.emit(t.types.PageHide)}))},onUnload(){t.instances.forEach((t=>{t.emit(t.types.PageHide)}))},onShareAppMessage(t){const e=ot.instances.length;if(!e)return t;const s=ot.instances[e-1];if(!s.sdk||!s.open||!s.autoConfig.pageShare)return t;return s.pageShare(t)},onAddToFavorites(t){if(!ot.instances.length)return;ot.instances.forEach((e=>{if(!e.sdk||!e.open||!e.autoConfig.pageFavorite)return;e.pageFavorite(t)}))}};if(t.platform&&"swan"===t.platformIs&&App.after&&Page.after)return App.after({methods:Object.assign({},e)}),Page.after({methods:Object.assign({},s)}),void 0;const i=App;App=function(t){return Object.keys(e).forEach((s=>{const i=t[s];t[s]=function(...t){try{e[s].apply(this,t)}catch(t){}return i&&i.apply(this,t)}})),i(t)};const n=Page;if(Page=function(t){const e=s;return Object.keys(e).forEach((s=>{const i=t[s];"onShareAppMessage"===s?i&&(t[s]=function(...t){const n=i?i.apply(this,t):{};try{const t=e[s].apply(this,[n]);n.path=t.path}catch(t){}return n}):"onAddToFavorites"===s?i&&(t[s]=function(...t){const n=i?i.apply(this,t):{};try{e[s].apply(this,[{res:t[0],result:n}])}catch(t){}return n}):t[s]=function(...t){try{e[s].apply(this,t)}catch(t){}return i&&i.apply(this,t)}})),n(t)},"undefined"!=typeof Component){const t=Component;Component=function(e){e.methods||(e.methods={});const i=s;return Object.keys(i).forEach((t=>{const s=e.methods[t];"onShareAppMessage"===t?s&&(e.methods[t]=function(...e){const n=s?s.apply(this,e):{};try{const e=i[t].apply(this,[n]);n.path=e.path}catch(t){}return n}):"onAddToFavorites"===t?s&&(e.methods[t]=function(...e){const n=s?s.apply(this,e):{};try{i[t].apply(this,[{res:e[0],result:n}])}catch(t){}return n}):e.methods[t]=function(...e){try{i[t].apply(this,e)}catch(t){}return s&&s.apply(this,e)}})),t(e)}}}apply(t,e){this.sdk=t,this.options=e,this.open=!!this.options.auto_report,this.open&&"object"==typeof this.options.auto_report&&(this.autoConfig=Object.assign(Object.assign({},this.autoConfig),this.options.auto_report||{})),this.proxySetTitle();const{types:s,adapter:i}=this.sdk,n=this.sdk.getKey("first");i.get(n).then((t=>{if(t===rt.False)return this.firstTime=rt.False,void 0;t||(this.firstTime=rt.True),i.set(n,rt.False)})),this.sdk.on(s.Ready,(()=>{this.queue.length>0&&(this.sdk.event([...this.queue]),this.queue.length=0)})),this.sdk.on(s.AppOpen,(t=>{this.appLaunch(t)})),this.missAppLaunch&&this.appLaunch(this.missAppLaunchInfo),this.sdk.on(s.AppShow,(t=>{this.open&&this.autoConfig.appLaunch&&this.appShow(t)})),this.open&&this.autoConfig.appLaunch&&this.missAppShow&&this.appShow(this.missAppShowInfo),this.sdk.on(s.AppHide,(()=>{this.open&&this.autoConfig.appTerminate&&this.appHide()})),this.sdk.on(s.AppError,(t=>{this.open&&this.autoConfig.appError&&this.appError(t)})),this.sdk.on(s.PageShow,(()=>{const t=this.getRouteInfo();if(t){const{path:e,query:s}=t;this.sdk.env.set({evtParams:Object.assign({$current_path:e},s?{$current_query:JSON.stringify(s)}:{})})}this.open&&this.autoConfig.pageShow&&this.pageShow()})),this.sdk.on(s.PageHide,(()=>{this.open&&this.autoConfig.pageHide&&this.pageHide()})),this.sdk.on(s.UuidChangeBefore,(()=>{this.open&&this.autoConfig.appTerminate&&this.appHide()})),this.sdk.on(s.UuidChangeAfter,(()=>{this.open&&this.autoConfig.appLaunch&&this.appShow(this.appInfo)}))}event(t,e){const{ready:s}=this.sdk;s?this.sdk.event(t,e):this.queue.push({event:t,params:e,local_time_ms:c()})}proxySetTitle(){const{target:t}=this.sdk;if(!t)return;const e=this;try{const s=t=>function(){return function(s){try{const t=getCurrentPages(),i=t[t.length-1].route||"";o(s)||(s={});const n=e.sdk.get("title-caches")||{};n[i]=s.title,e.sdk.set("title-caches",n)}catch(t){}t.call(this,s)}};if(void 0!==t.setNavigationBarTitle){const e=t.setNavigationBarTitle;Object.defineProperty(t,"setNavigationBarTitle",{get:s(e)})}else if(void 0!==t.setNavigationBar){const e=t.setNavigationBar;Object.defineProperty(t,"setNavigationBar",{get:s(e)})}}catch(t){}}getPageTitle(t){const{targetEnvConfig:e}=this.sdk,s=this.sdk.get("title-caches");let i="";if(void 0!==(null==s?void 0:s[t])&&(i=s[t]),!i)try{if(e){const s=e.page[t]||e.page[t+".html"];s&&(i=s.window.navigationBarTitleText),i||(i=e.global.window.navigationBarTitleText)}}catch(t){}return i}getRouteInfo(t=1,e){try{const s=(e=e||getCurrentPages()).length-t;if(s<0)return null;const{route:i="",options:n={}}=e[s];return{path:i,query:n}}catch(t){}return null}getCurrentPage(){const t=getCurrentPages()||[];return t[t.length-1]}getQuery(t={}){const e={};if(o(t)){if(t.scene){const s=x(C(`${t.scene}`));Object.keys(s).forEach((t=>{e[`query_${t}`]=s[t]}))}Object.keys(t).forEach((s=>{if(!this.sdk.UtmType.includes(s)&&"scene"!==s){let i=t[s];"from_title"===s&&(i=encodeURIComponent(C(t[s]))),e[`query_${s}`]=i}}))}return e}fixInfo(t,e){let s=e;if(!e.path)if(e.args)s=e.args;else try{JSON.stringify(e)}catch(t){s={query:{}}}const i={info:s};return this.sdk.emit(this.sdk.types.TransformInfo,{type:t,rawInfo:e,wrapInfo:i}),s=i.info,s}appLaunch(t){var e,s,i;this.appInfo=t||(null===(s=(e=this.sdk.target).getLaunchOptionsSync)||void 0===s?void 0:s.call(e)),this.appInfo=this.fixInfo("App.onLaunch",this.appInfo),this.scene=null===(i=this.appInfo)||void 0===i?void 0:i.scene,this.sdk.checkUsePlugin("official:utm")?this.sdk.emit(this.sdk.types.LaunchInfo,this.appInfo):this.sdk.emit(this.sdk.types.LaunchComplete)}}ot.pluginName="official:auto",ot.instances=[];E.usePlugin(R),E.usePlugin(H),E.usePlugin(M),E.usePlugin(K),E.usePlugin(F),E.usePlugin(J),E.usePlugin(nt),E.usePlugin(class extends ot{constructor(){super(...arguments),this.sessionStart=0,this.sessionDepth=0,this.shareDepth=0}appShow(e){e=e||this.appInfo,e=this.fixInfo("App.onShow",e);const s=this.sdk.sessionId;this.sessionStart=c();const{query:{share_depth:i=0}={}}=e;this.shareDepth=Number(i)||0;const{EventType:n}=this.sdk,{referrerInfo:r}=e,o=t(e,["referrerInfo"]),{query:a}=o,h=t(o,["query"]),p=Object.assign(Object.assign({},a),r),u=Object.assign(Object.assign(Object.assign({session_id:s,$is_first_time:this.firstTime},h),this.scene?{scene:this.scene}:{}),this.getQuery(p));this.sdk.emit(this.sdk.types.ExtendAppLaunch,u),this.event(n.appOnShow,u),this.firstTime===rt.True&&(this.firstTime=rt.False)}appHide(){const{route:t,__route__:e,options:s={}}=this.getCurrentPage(),i=t||e,n=Object.assign(Object.assign({exit_page:i,session_duration:Math.ceil((c()-this.sessionStart)/1e3),session_depth:this.sessionDepth,session_id:this.sdk.sessionId},this.scene?{scene:this.scene}:{}),this.getQuery(s));this.sdk.emit(this.sdk.types.ExtendAppTerminate,n),this.event(this.sdk.EventType.appOnHide,n)}appError(t){const e={on_error:t,session_id:this.sdk.sessionId};this.sdk.emit(this.sdk.types.ExtendAppError,e),this.event(this.sdk.EventType.appOnError,e)}pageShow(){this.sessionDepth+=1;const{route:t,__route__:e,options:s={}}=this.getCurrentPage(),i=t||e,{EventType:n}=this.sdk,r=Object.assign(Object.assign({path:i,title:this.getPageTitle(i),session_id:this.sdk.sessionId},this.scene?{scene:this.scene}:{}),this.getQuery(s));let o=null;if(this.recentlyPage)o=this.recentlyPage;else{const t=this.getRouteInfo(2);t&&(o=t)}if(o){const{path:t="",query:e={}}=o;r.refer_path=t,r.refer_query=JSON.stringify(e)}this.sdk.emit(this.sdk.types.ExtendPageShow,r),this.recentlyPage={path:i,query:s},this.currentPvInfo={time:c(),params:Object.assign({},r)},this.event(n.pageOnShow,r)}pageHide(){if(!this.currentPvInfo)return;const{time:t,params:e}=this.currentPvInfo;this.currentPvInfo=null;let s=c()-t;s=s<0?0:s;const i=Object.assign(Object.assign({},e||{}),{duration:s});this.sdk.emit(this.sdk.types.ExtendPageHide,i),this.event(this.sdk.EventType.pageOnHide,i)}pageShare(t){const{user:{user_unique_id:e}}=this.sdk.env.get(),s=this.shareDepth+1;if(t.path){let{path:i}=t,n="";const r=i.indexOf("#");-1!==r&&(n=i.substr(r),i=i.substr(0,r));const o=`from_user_unique_id=${e}&share_depth=${s}&from_title=${t.title}`;i+=`${-1!==i.indexOf("?")?"&":"?"}${o}`,t.path=i+n}const{title:i,path:n=""}=t,r={title:i,path:n,page_path:n.split("?")[0],query_share_depth:s,session_id:this.sdk.sessionId};return this.sdk.emit(this.sdk.types.ExtendPageShare,r),this.event(this.sdk.EventType.pageOnShareAppMessage,r),Object.assign(Object.assign({},t),{share_depth:s})}pageFavorite(e){const{res:s,result:i}=e||{},n=getCurrentPages(),r=n[n.length-1],{route:o,__route__:a}=r,h=o||a,{query:c}=i,p=t(i,["query"]),u=Object.assign({url_path:(null==s?void 0:s.webViewUrl)||h,url_query:c},p);this.sdk.emit(this.sdk.types.ExtendPageFavorite,u),this.event(this.sdk.EventType.pageOnAddToFavorites,u)}});var at=new E;export{at as default};
