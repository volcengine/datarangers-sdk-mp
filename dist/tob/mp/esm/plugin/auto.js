function t(t,e){var s={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(s[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(t,i[n])&&(s[i[n]]=t[i[n]])}return s}const e=()=>+new Date,s=t=>null!=t&&"[object Object]"==Object.prototype.toString.call(t),i=t=>{let e=t;try{e=decodeURIComponent(t)}catch(t){}return e};var n;!function(t){t.True="true",t.False="false"}(n||(n={}));class o{constructor(){this.queue=[],this.firstTime=n.False,this.open=!1,this.launched=!1,this.autoConfig={appLaunch:!0,appTerminate:!0,appError:!0,pageShow:!0,pageHide:!0,pageShare:!0,pageFavorite:!0},this.missAppLaunch=!1,this.missAppShow=!1,o.instances.push(this)}static init(t){const e={onLaunch(e){t.instances.forEach((t=>{t.emit(t.types.AppOpen,e)})),o.instances.forEach((t=>{t.sdk||(t.missAppLaunch=!0,t.missAppLaunchInfo=e)}))},onShow(e){t.instances.forEach((t=>{t.emit(t.types.AppShowStart,e),t.emit(t.types.AppShow,e)})),o.instances.forEach((t=>{t.sdk||(t.missAppShow=!0,t.missAppShowInfo=e)}))},onHide(){t.instances.forEach((t=>{t.emit(t.types.AppHide),t.emit(t.types.AppClose)}))},onError(e){t.instances.forEach((t=>{t.emit(t.types.AppError,e)}))}},s={onShow(){t.instances.forEach((t=>{t.emit(t.types.PageShow)}))},onHide(){t.instances.forEach((t=>{t.emit(t.types.PageHide)}))},onUnload(){t.instances.forEach((t=>{t.emit(t.types.PageHide)}))},onShareAppMessage(t){const e=o.instances.length;if(!e)return t;const s=o.instances[e-1];if(!s.sdk||!s.open||!s.autoConfig.pageShare)return t;return s.pageShare(t)},onAddToFavorites(t){if(!o.instances.length)return;o.instances.forEach((e=>{if(!e.sdk||!e.open||!e.autoConfig.pageFavorite)return;e.pageFavorite(t)}))}};if(t.platform&&"swan"===t.platformIs&&App.after&&Page.after)return App.after({methods:Object.assign({},e)}),Page.after({methods:Object.assign({},s)}),void 0;const i=App;App=function(t){return Object.keys(e).forEach((s=>{const i=t[s];t[s]=function(...t){try{e[s].apply(this,t)}catch(t){}return i&&i.apply(this,t)}})),i(t)};const n=Page;if(Page=function(t){const e=s;return Object.keys(e).forEach((s=>{const i=t[s];"onShareAppMessage"===s?i&&(t[s]=function(...t){const n=i?i.apply(this,t):{};try{const t=e[s].apply(this,[n]);n.path=t.path}catch(t){}return n}):"onAddToFavorites"===s?i&&(t[s]=function(...t){const n=i?i.apply(this,t):{};try{e[s].apply(this,[{res:t[0],result:n}])}catch(t){}return n}):t[s]=function(...t){try{e[s].apply(this,t)}catch(t){}return i&&i.apply(this,t)}})),n(t)},"undefined"!=typeof Component){const t=Component;Component=function(e){e.methods||(e.methods={});const i=s;return Object.keys(i).forEach((t=>{const s=e.methods[t];"onShareAppMessage"===t?s&&(e.methods[t]=function(...e){const n=s?s.apply(this,e):{};try{const e=i[t].apply(this,[n]);n.path=e.path}catch(t){}return n}):"onAddToFavorites"===t?s&&(e.methods[t]=function(...e){const n=s?s.apply(this,e):{};try{i[t].apply(this,[{res:e[0],result:n}])}catch(t){}return n}):e.methods[t]=function(...e){try{i[t].apply(this,e)}catch(t){}return s&&s.apply(this,e)}})),t(e)}}}apply(t,e){this.sdk=t,this.options=e,this.open=!!this.options.auto_report,this.open&&"object"==typeof this.options.auto_report&&(this.autoConfig=Object.assign(Object.assign({},this.autoConfig),this.options.auto_report||{})),this.proxySetTitle();const{types:s,adapter:i}=this.sdk,o=this.sdk.getKey("first");i.get(o).then((t=>{if(t===n.False)return this.firstTime=n.False,void 0;t||(this.firstTime=n.True),i.set(o,n.False)})),this.sdk.on(s.Ready,(()=>{this.queue.length>0&&(this.sdk.event([...this.queue]),this.queue.length=0)})),this.sdk.on(s.AppOpen,(t=>{this.appLaunch(t)})),this.missAppLaunch&&this.appLaunch(this.missAppLaunchInfo),this.sdk.on(s.AppShow,(t=>{this.open&&this.autoConfig.appLaunch&&this.appShow(t)})),this.open&&this.autoConfig.appLaunch&&this.missAppShow&&this.appShow(this.missAppShowInfo),this.sdk.on(s.AppHide,(()=>{this.open&&this.autoConfig.appTerminate&&this.appHide()})),this.sdk.on(s.AppError,(t=>{this.open&&this.autoConfig.appError&&this.appError(t)})),this.sdk.on(s.PageShow,(()=>{const t=this.getRouteInfo();if(t){const{path:e,query:s}=t;this.sdk.env.set({evtParams:Object.assign({$current_path:e},s?{$current_query:JSON.stringify(s)}:{})})}this.open&&this.autoConfig.pageShow&&this.pageShow()})),this.sdk.on(s.PageHide,(()=>{this.open&&this.autoConfig.pageHide&&this.pageHide()})),this.sdk.on(s.UuidChangeBefore,(()=>{this.open&&this.autoConfig.appTerminate&&this.appHide()})),this.sdk.on(s.UuidChangeAfter,(()=>{this.open&&this.autoConfig.appLaunch&&this.appShow(this.appInfo)}))}event(t,s){const{ready:i}=this.sdk;i?this.sdk.event(t,s):this.queue.push({event:t,params:s,local_time_ms:e()})}proxySetTitle(){const{target:t}=this.sdk;if(!t)return;const e=this;try{const i=t=>function(){return function(i){try{const t=getCurrentPages(),n=t[t.length-1].route||"";s(i)||(i={});const o=e.sdk.get("title-caches")||{};o[n]=i.title,e.sdk.set("title-caches",o)}catch(t){}t.call(this,i)}};if(void 0!==t.setNavigationBarTitle){const e=t.setNavigationBarTitle;Object.defineProperty(t,"setNavigationBarTitle",{get:i(e)})}else if(void 0!==t.setNavigationBar){const e=t.setNavigationBar;Object.defineProperty(t,"setNavigationBar",{get:i(e)})}}catch(t){}}getPageTitle(t){const{targetEnvConfig:e}=this.sdk,s=this.sdk.get("title-caches");let i="";if(void 0!==(null==s?void 0:s[t])&&(i=s[t]),!i)try{if(e){const s=e.page[t]||e.page[t+".html"];s&&(i=s.window.navigationBarTitleText),i||(i=e.global.window.navigationBarTitleText)}}catch(t){}return i}getRouteInfo(t=1,e){try{const s=(e=e||getCurrentPages()).length-t;if(s<0)return null;const{route:i="",options:n={}}=e[s];return{path:i,query:n}}catch(t){}return null}getCurrentPage(){const t=getCurrentPages()||[];return t[t.length-1]}getQuery(t={}){const e={};if(s(t)){if(t.scene){const s=(t=>{const e={};return t&&t.split("&").forEach((t=>{if(t){const s=t.split("=");s[0]&&(e[s[0]]=s[1]||"")}})),e})(i(`${t.scene}`));Object.keys(s).forEach((t=>{e[`query_${t}`]=s[t]}))}Object.keys(t).forEach((s=>{if(!this.sdk.UtmType.includes(s)&&"scene"!==s){let n=t[s];"from_title"===s&&(n=encodeURIComponent(i(t[s]))),e[`query_${s}`]=n}}))}return e}fixInfo(t,e){let s=e;if(!e.path)if(e.args)s=e.args;else try{JSON.stringify(e)}catch(t){s={query:{}}}const i={info:s};return this.sdk.emit(this.sdk.types.TransformInfo,{type:t,rawInfo:e,wrapInfo:i}),s=i.info,s}appLaunch(t){var e,s,i;this.appInfo=t||(null===(s=(e=this.sdk.target).getLaunchOptionsSync)||void 0===s?void 0:s.call(e)),this.appInfo=this.fixInfo("App.onLaunch",this.appInfo),this.scene=null===(i=this.appInfo)||void 0===i?void 0:i.scene,this.sdk.checkUsePlugin("official:utm")?this.sdk.emit(this.sdk.types.LaunchInfo,this.appInfo):this.sdk.emit(this.sdk.types.LaunchComplete)}}o.pluginName="official:auto",o.instances=[];class a extends o{constructor(){super(...arguments),this.sessionStart=0,this.sessionDepth=0,this.shareDepth=0}appShow(s){s=s||this.appInfo,s=this.fixInfo("App.onShow",s);const i=this.sdk.sessionId;this.sessionStart=e();const{query:{share_depth:o=0}={}}=s;this.shareDepth=Number(o)||0;const{EventType:a}=this.sdk,{referrerInfo:r}=s,h=t(s,["referrerInfo"]),{query:p}=h,c=t(h,["query"]),u=Object.assign(Object.assign({},p),r),d=Object.assign(Object.assign(Object.assign({session_id:i,$is_first_time:this.firstTime},c),this.scene?{scene:this.scene}:{}),this.getQuery(u));this.sdk.emit(this.sdk.types.ExtendAppLaunch,d),this.event(a.appOnShow,d),this.firstTime===n.True&&(this.firstTime=n.False)}appHide(){const{route:t,__route__:s,options:i={}}=this.getCurrentPage(),n=t||s,o=Object.assign(Object.assign({exit_page:n,session_duration:Math.ceil((e()-this.sessionStart)/1e3),session_depth:this.sessionDepth,session_id:this.sdk.sessionId},this.scene?{scene:this.scene}:{}),this.getQuery(i));this.sdk.emit(this.sdk.types.ExtendAppTerminate,o),this.event(this.sdk.EventType.appOnHide,o)}appError(t){const e={on_error:t,session_id:this.sdk.sessionId};this.sdk.emit(this.sdk.types.ExtendAppError,e),this.event(this.sdk.EventType.appOnError,e)}pageShow(){this.sessionDepth+=1;const{route:t,__route__:s,options:i={}}=this.getCurrentPage(),n=t||s,{EventType:o}=this.sdk,a=Object.assign(Object.assign({path:n,title:this.getPageTitle(n),session_id:this.sdk.sessionId},this.scene?{scene:this.scene}:{}),this.getQuery(i));let r=null;if(this.recentlyPage)r=this.recentlyPage;else{const t=this.getRouteInfo(2);t&&(r=t)}if(r){const{path:t="",query:e={}}=r;a.refer_path=t,a.refer_query=JSON.stringify(e)}this.sdk.emit(this.sdk.types.ExtendPageShow,a),this.recentlyPage={path:n,query:i},this.currentPvInfo={time:e(),params:Object.assign({},a)},this.event(o.pageOnShow,a)}pageHide(){if(!this.currentPvInfo)return;const{time:t,params:s}=this.currentPvInfo;this.currentPvInfo=null;let i=e()-t;i=i<0?0:i;const n=Object.assign(Object.assign({},s||{}),{duration:i});this.sdk.emit(this.sdk.types.ExtendPageHide,n),this.event(this.sdk.EventType.pageOnHide,n)}pageShare(t){const{user:{user_unique_id:e}}=this.sdk.env.get(),s=this.shareDepth+1;if(t.path){let{path:i}=t,n="";const o=i.indexOf("#");-1!==o&&(n=i.substr(o),i=i.substr(0,o));const a=`from_user_unique_id=${e}&share_depth=${s}&from_title=${t.title}`;i+=`${-1!==i.indexOf("?")?"&":"?"}${a}`,t.path=i+n}const{title:i,path:n=""}=t,o={title:i,path:n,page_path:n.split("?")[0],query_share_depth:s,session_id:this.sdk.sessionId};return this.sdk.emit(this.sdk.types.ExtendPageShare,o),this.event(this.sdk.EventType.pageOnShareAppMessage,o),Object.assign(Object.assign({},t),{share_depth:s})}pageFavorite(e){const{res:s,result:i}=e||{},n=getCurrentPages(),o=n[n.length-1],{route:a,__route__:r}=o,h=a||r,{query:p}=i,c=t(i,["query"]),u=Object.assign({url_path:(null==s?void 0:s.webViewUrl)||h,url_query:p},c);this.sdk.emit(this.sdk.types.ExtendPageFavorite,u),this.event(this.sdk.EventType.pageOnAddToFavorites,u)}}export{a as default};
