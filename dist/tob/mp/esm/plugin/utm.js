const t=()=>+new Date,e=t=>{let e=t;try{e=decodeURIComponent(t)}catch(t){}return e};class s{constructor(){this.key="utm"}apply(t,e){this.sdk=t,this.options=e;const{types:s}=this.sdk;this.sdk.on(s.LaunchInfo,(t=>{var e,s;this.parseDefault(null!==(e=null==t?void 0:t.query)&&void 0!==e?e:{}),this.parseMore(null!==(s=null==t?void 0:t.query)&&void 0!==s?s:{})}))}parseDefault(t={}){let s=!1;const i=Object.keys(t).reduce(((i,h)=>(this.sdk.UtmType.includes(h)&&(s=!0,i[h]=e(t[h])),i)),{});s&&this.sdk.env.set(i)}parseMore(t={}){const{tr_token:s="",surl_token:i="",scene:h=""}=t||{};let n=s||i;if(h){const t=(t=>{const e={};return t&&t.split("&").forEach((t=>{if(t){const s=t.split("=");s[0]&&(e[s[0]]=s[1]||"")}})),e})(e(`${h}`));t.tr_token&&(n=t.tr_token),this.sdk.set("scene_extra_query",t)}if(!n)return this.dispatch(),void 0;this.storageGet(n).then((t=>{t?(this.sdk.env.set(t.utms||{}),this.dispatch()):this.fetch(n).then((()=>this.dispatch())).catch((()=>this.dispatch()))})).catch((()=>{this.fetch(n).then((()=>this.dispatch())).catch((()=>this.dispatch()))}))}storageGet(e){const s=this.sdk.getKey(this.key),{adapter:i}=this.sdk;return i.get(s).then((h=>{const n=t(),c=[];if(Object.keys(h).forEach((t=>{h[t]&&h[t].timestamp+864e7<n&&c.push(t)})),c.length>0&&(c.forEach((t=>{delete h[t]})),i.set(s,h)),h&&h[e])return h[e];return null}))}storageSet(e,s){const i=this.sdk.getKey(this.key),{adapter:h}=this.sdk;h.get(i).then((n=>{n||(n={}),n[e]={utms:s,timestamp:t()},h.set(i,n)}))}fetch(t){const{adapter:e,option:s,env:i,UtmType:h}=this.sdk;return e.request({url:`${s.get("domain")}/service/2/mp_campaigns`,method:"GET",data:{tr_token:t},timeout:3e3}).then((s=>{const{data:{code:n=-1,data:c={},message:a=""}={}}=s||{};if(0===n){if(null!=(o=c)&&"[object Object]"==Object.prototype.toString.call(o)){let e=!1;const s=Object.keys(c).reduce(((t,i)=>(h.includes(i)&&(e=!0,s[i]=c[i]),t)),{});e&&i.set(s),this.storageSet(t,s)}}else 40002===n&&this.storageSet(t,{});var o;0!==n&&e.log(a||"")}))}dispatch(){this.sdk.emit(this.sdk.types.LaunchComplete)}}s.pluginName="official:utm";export{s as default};
