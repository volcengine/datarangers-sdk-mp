class t{constructor(){this.key="start_rangers_data_check",this.buffer=[],this.test=!1,this.testRequestNumber=0,this.interval=1e3,this.needOn=!1,this.onHandler=()=>{}}apply(t,e){this.sdk=t,this.options=e;const{types:s}=this.sdk;this.sdk.once(s.AppOpen,(t=>{try{if(this.host=t,t.getLaunchOptionsSync){const e=t.getLaunchOptionsSync(),{query:i}=e;this.verify(i).then((()=>{this.needOn=!0,this.onHandler=t=>{this.submit(t)},this.sdk.on(s.Event,this.onHandler)}))}}catch(t){}})),this.sdk.on(s.AppClose,(()=>{this.needOn&&(this.userInfo=null,this.sdk.off(s.Event,this.onHandler),this.onHandler=()=>{},this.needOn=!1)}))}check(t){var e;return null!==(e=null==t?void 0:t[this.key])&&void 0!==e?e:""}verify(t){const{adapter:e}=this.sdk;let s;const i=new Promise((t=>{s=t})),r=t=>{s(!0),this.userInfo=t||{nickName:"未知",avatarUrl:""},e.log(`verify open ${JSON.stringify(this.userInfo)}`),this.login()},n=this.check(t);if(e.log(`verify ${n}`),n){try{const t=(t=>{const e=e=>{return(s=t,s.split("").map((t=>t.charCodeAt(0)))).reduce(((t,e)=>t^e),e);var s};return t=>t.match(/.{1,2}/g).map((t=>parseInt(t,16))).map(e).map((t=>String.fromCharCode(t))).join("")})("logverify")(n);t&&/^https?:\/\//.test(t)&&(this.domain=t),e.log(`verify domain ${t}`)}catch(t){}this.host.getSetting({success(t){e.log("getSetting success"),t.authSetting["scope.userInfo"]?(e.log("getSetting scope.userInfo success"),this.host.getUserInfo?this.host.getUserInfo({success(t){e.log("getUserInfo success");const{nickName:s,avatarUrl:i}=t.userInfo;r({nickName:s,avatarUrl:i})},fail(){e.log("getUserInfo fail"),r()}}):this.host.getOpenUserInfo&&this.host.getOpenUserInfo({success(t){e.log("getUserInfo success");try{const e=JSON.parse(t.response).response,{nickName:s,avatar:i}=e;r({nickName:s,avatarUrl:i})}catch(t){}},fail(){e.log("getUserInfo fail"),r()}})):(e.log("getSetting scope.userInfo fail"),r())},fail(){e.log("getSetting fail"),r()}})}return i}submit(t){try{this.pushBuffer(JSON.parse(JSON.stringify(t)))}catch(t){}}login(){if(!this.domain)return;const{header:t}=this.prepareHeader();this.sdk.adapter.request({url:`${this.domain}/simulator/limited_mobile/try_link`,method:"POST",data:Object.assign(Object.assign({header:Object.assign(Object.assign({},t||{}),{aid:t.app_id})},this.userInfo?{nick_name:this.userInfo.nickName}:{}),{host_version:(t.custom||{}).mp_platform_app_version||"",sync_id:this.syncId||""})}).then((t=>{try{const{data:{data:{retry:e,sync_id:s,token:i}}}=t;if(this.syncId=s,this.token=i,this.test&&this.testRequestNumber>3)return this.report(),void 0;0===e||(1===e?this.loginLoop():2===e&&this.report())}catch(t){this.loginLoop()}})).catch((()=>{this.loginLoop()}))}loginLoop(){this.test&&this.testRequestNumber++,setTimeout((()=>{this.login()}),this.interval)}report(){if(!this.domain)return;const{header:t}=this.prepareHeader(),e=this.buffer;this.buffer=[],this.sdk.adapter.request({url:`${this.domain}/simulator/limited_mobile/log`,method:"POST",data:{header:Object.assign(Object.assign({},t||{}),{aid:t.app_id}),token:this.token||"",event_v3:e||[]}}).then((t=>{try{const{data:{data:{keep:e}}}=t;!0===e?this.reportLoop():this.reset()}catch(t){this.reportLoop()}})).catch((()=>{this.reportLoop()}))}reportLoop(){setTimeout((()=>{this.report()}),this.interval)}pushBuffer(t){(Array.isArray(t)?[...t]:[t]).forEach((t=>{if("string"==typeof t.params)try{t.params=JSON.parse(t.params)}catch(t){}this.buffer.push(t)}))}prepareHeader(){const{env:t}=this.sdk,{user:e,header:s}=t.get();return JSON.parse(JSON.stringify({user:e,header:s}))}reset(){this.buffer=[],this.syncId="",this.token=""}}t.pluginName="official:verify";export{t as default};
