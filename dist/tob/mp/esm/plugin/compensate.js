const t=()=>+new Date;class e{constructor(){this.key="compensate",this.cache=new Map,this.batchMax=10,this.enable=!1,this.storageCache=new Map}apply(t,e){this.sdk=t,this.options=e,this.reportUrl=this.sdk.get("report_url"),this.enable=this.sdk.get("enable_storage"),this.options.enable_storage_only&&(this.enable=!0);const{types:s}=this.sdk;this.enable&&this.sdk.on(s.Ready,(()=>{this.storageGet().then((t=>{if(!this.reportUrl||!t||!Array.isArray(t))return;const e=t=>new Promise((e=>{this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:t}).then((()=>{e(null)})).catch((()=>{e(null)}))}));if(t.length>50){const s=[...t],r=()=>{const t=s.splice(0,50);t.length>0&&e(t).then((()=>{s.length>0&&r()}))};r()}else e(t)}))})),this.sdk.on(s.SubmitError,(t=>{const e=this.random(),{event:s}=t;this.cache.set(e,s),this.process()})),this.sdk.on(s.AppClose,(()=>{this.report()}))}process(){this.cache.size>=this.batchMax&&this.report()}report(){if(!this.reportUrl&&(this.reportUrl=this.sdk.get("report_url"),!this.reportUrl))return;let t=[];if(this.cache.forEach((e=>{t=[...t,...e]})),t.length>0){const e=this.random();this.enable&&this.storageCache.set(e,t),this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:t}).then((()=>{this.enable&&this.storageCache.delete(e)})).catch((()=>{if(this.enable){let t=[];this.storageCache.forEach((e=>{t=[...t,...e]})),this.storageSet(t)}})),this.cache=new Map}}storageGet(){const e=this.sdk.getKey(this.key),{adapter:s}=this.sdk;return s.get(e).then((r=>{if(s.remove(e),null==(a=r)||"[object Object]"!=Object.prototype.toString.call(a)||!r.timestamp)return null;var a;const h=t();if(r.timestamp+864e7<h)return null;return r.data}))}storageSet(e){const s=this.sdk.getKey(this.key),{adapter:r}=this.sdk;r.set(s,{data:e,timestamp:t()})}random(){return`${+new Date}_${Math.floor(1e10*Math.random())}`}}e.pluginName="official:compensate";export{e as default};
