import e from"./plugin/robot";import t from"./plugin/verify";import s from"./plugin/ab";import i from"./plugin/utm";import r from"./plugin/compensate";import n from"./plugin/monitor";import o from"./plugin/extend";import a from"./plugin/auto";function h(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}const p=void 0,u={cn:"https://mcs.volceapplog.com",va:"https://mcs.itobsnssdk.com",sg:"https://mcs.tobsnssdk.com"},c={appOnShow:"app_launch",appOnHide:"app_terminate",appOnError:"on_error",pageOnShow:"predefine_pageview",pageOnHide:"predefine_pageview_hide",pageOnShareAppMessage:"on_share",pageOnAddToFavorites:"on_addtofavorites"},l=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],d=["__profile_set","__profile_set_once","__profile_increment","__profile_unset","__profile_append"],f=e=>null!=e&&"[object Object]"==Object.prototype.toString.call(e),m=e=>"function"==typeof e,g=e=>"number"==typeof e&&!isNaN(e),_=()=>+new Date;class b{constructor(e){this.sdk=e,this.env=this.init()}init(){return{user:{web_id:p,user_unique_id:p,user_id:p,user_type:p,user_is_auth:p,user_is_login:p,ip_addr_id:p,device_id:p},header:{app_id:p,app_name:p,app_install_id:p,install_id:p,app_package:p,app_channel:p,app_version:p,os_name:p,os_version:p,device_model:p,device_brand:p,traffic_type:p,client_ip:p,os_api:p,access:p,language:p,app_language:p,creative_id:p,ad_id:p,campaign_id:p,ab_client:p,ab_version:p,platform:p,sdk_version:p,sdk_lib:p,app_region:p,region:p,province:p,city:p,timezone:p,tz_offset:p,tz_name:p,sim_region:p,carrier:p,resolution:p,screen_width:p,screen_height:p,browser:p,browser_version:p,referrer:p,referrer_host:p,utm_source:p,utm_medium:p,utm_campaign:p,utm_term:p,utm_content:p,custom:{},ab_sdk_version:p,_sdk_version:p,_sdk_name:p,wechat_openid:p,wechat_unionid:p}}}set(e){this.sdk.emit(this.sdk.types.EnvTransform,e),Object.keys(e).forEach((t=>{if("evtParams"===t)this.evtParams=Object.assign(Object.assign({},this.evtParams||{}),e.evtParams||{});else if("_staging_flag"===t)this.evtParams=Object.assign(Object.assign({},this.evtParams||{}),{_staging_flag:e._staging_flag});else{let s=t,i=e[t];if(null===i)return!1;let r="";s.indexOf(".")>-1&&([r,s]=s.split(".")),"platform"===s&&(i="mp"),"os_version"!==s&&"mp_platform"!==s||(i=`${i}`),r?("headers"===r&&(r="header"),"user"===r||"header"===r?this.env[r][s]=i:this.env.header.custom[s]=i):this.env.user.hasOwnProperty(s)?["user_type","ip_addr_id"].indexOf(s)>-1?this.env.user[s]=Number(i):["user_id","web_id","user_unique_id"].indexOf(s)>-1?this.env.user[s]=String(i):["user_is_auth","user_is_login"].indexOf(s)>-1?this.env.user[s]=Boolean(i):["device_id"].indexOf(s)>-1&&(this.env.user[s]=i):this.env.header.hasOwnProperty(s)?this.env.header[s]=i:this.env.header.custom[s]=i}}))}get(e){if(!e||"env"===e)return this.clone(this.env);if("evtParams"===e)return Object.assign({},this[e]);if(this.env.hasOwnProperty(e))return this.clone(this.env[e]);if(this.env.user.hasOwnProperty(e))return this.clone(this.env.user[e]);if(this.env.header.hasOwnProperty(e))return this.clone(this.env.header[e]);if(this.env.header.custom.hasOwnProperty(e))return this.clone(this.env.header.custom[e])}compose(e,t=[]){const{user:s,header:i}=this.env,{evtParams:r}=this,n=e.map((e=>(e.event&&!t.includes(e.event)&&r&&Object.keys(r).forEach((t=>{void 0===e.params[t]&&(e.params[t]=r[t])})),e.params=JSON.stringify(e.params),e)));return this.clone({events:n,user:s,header:i})}merge(e,t=[]){const s=this.compose(e,t);return s.local_time=Math.floor(_()/1e3),[s]}clone(e){if(f(e))return JSON.parse(JSON.stringify(e));return e}}class y{constructor(){this.domains=u,this.init()}init(){this.option={caller:"",log:!1,channel:"cn",report_channel:"cn",channel_domain:"",report_url:"",auto_report:false,auto_profile:false,profile_channel:"cn",enable_profile:false,enable_ab_test:false,ab_channel_domain:"",clear_ab_cache_on_user_change:true,enable_et_test:false,event_verify_url:"",enable_buffer:false,buffer_interval:5e3,buffer_number:5,enable_storage_only:false,enable_filter_list:false,enable_third:false,enable_filter_crawler:false,request_timeout:0,enable_initiative_launch:false,enable_custom_webid:false,disable_sdk_monitor:false},this.cloneOption=Object.assign({},this.option),this.initDomain()}initDomain(){if(this.option.channel_domain)return this.domain=this.option.channel_domain,void 0;let e=this.option.report_channel;Object.keys(this.domains).includes(e)||(e="cn"),this.domain=this.domains[e]}set(e){if(!f(e))return;Object.keys(e).forEach((t=>{this.option.hasOwnProperty(t)&&("channel"===t||"report_channel"===t?(this.option.report_channel=this.option.channel=e[t]?e[t]:this.cloneOption[t],this.initDomain()):(this.option[t]=void 0===e[t]?this.cloneOption[t]:e[t],"channel_domain"===t&&this.initDomain()))}))}get(e){if(e){if(this.hasOwnProperty(e))return this[e];if(this.option.hasOwnProperty(e))return this.option[e];return}return Object.assign({},this.option)}}class v{constructor(){this.hooks={}}on(e,t){if(!e||!t||"function"!=typeof t)return;this.hooks[e]||(this.hooks[e]=[]),this.hooks[e].push(t)}once(e,t){if(!e||!t||"function"!=typeof t)return;const s=i=>{t(i),this.off(e,s)};this.on(e,s)}off(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;if(t){const s=this.hooks[e].indexOf(t);-1!==s&&this.hooks[e].splice(s,1)}else this.hooks[e]=[]}emit(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;[...this.hooks[e]].forEach((e=>{try{e(t)}catch(e){}}))}}class k{constructor(e){this.ready=!1,this.sdk=e}setLog(e){e&&m(e.log)&&(this._log=e)}setRequest(e){if(m(e)){const t=e(this.sdk);m(t)&&(this._request=t)}}setStorage(e){f(e)&&m(e.get)&&m(e.set)&&m(e.remove)&&(this._storage=e)}check(){if(!this._request||!this._storage)return;this.ready=!0}log(...e){if(!this._log)return;try{this.sdk.option.get("log")&&this._log.log(...e)}catch(e){}}request(e){var t;if(!this.ready)return Promise.reject();try{return null===(t=this._request)||void 0===t?void 0:t.call(this,e)}catch(e){}}get(e){if(!this.ready)return Promise.reject(null);return this._storage.get(e)}set(e,t){if(!this.ready)return Promise.reject(!1);return this._storage.set(e,t)}remove(e){if(!this.ready)return Promise.reject(!1);return this._storage.remove(e)}}var w;!function(e){e.Init="$init",e.Config="$config",e.Send="$send",e.Ready="$ready",e.TokenComplete="$token-complete",e.TokenStorage="$token-storage",e.TokenFetch="$token-fetch",e.TokenGet="$token-get",e.LaunchComplete="$launch-complete",e.ConfigUuid="$config-uuid",e.ConfigWebId="$config-webid",e.ConfigTransform="$config-transform",e.UuidChangeBefore="$uuid-change-before",e.UuidChangeAfter="$uuid-change-after",e.EnvTransform="$env-transform",e.Event="$event",e.Report="$report",e.AppOpen="$app-open",e.AppClose="$app-close",e.AppShowStart="$app-show-start",e.AppShow="$app-show",e.AppHide="$app-hide",e.AppError="$app-error",e.AppShare="$app-share",e.AppOnShare="$app-on-share",e.PageShow="$page-show",e.PageHide="$page-hide",e.PageShare="$page-share",e.SubmitBefore="$submit-before",e.SubmitAfter="$submit-after",e.SubmitError="$submit-error",e.FilterCrawler="$filter-crawler",e.LaunchInfo="$launch-info",e.AbVar="$ab-var",e.AbAllVars="$ab-all-vars",e.AbExternalVersion="$ab-external-version",e.AbVersionChangeOn="$ab-version-change-on",e.AbVersionChangeOff="$ab-version-change-off",e.AbRefresh="$ab-refresh",e.AbFetchAfter="$ab-fetch-After",e.ProfileSet="$profile-set",e.ProfileSetOnce="$profile-set-once",e.ProfileUnset="$profile-unset",e.ProfileIncrement="$profile-increment",e.ProfileAppend="$profile-append",e.ProfileClear="$profile-clear",e.ProfileSubmitAfter="$profile-submit-after",e.ProfileSubmitError="$profile-submit-error",e.TransformInfo="$transform-info",e.ExtendAppLaunch="$extend-app-launch",e.ExtendAppTerminate="$extend-app-terminate",e.ExtendAppError="$extend-app-error",e.ExtendPageShow="$extend-page-show",e.ExtendPageHide="$extend-page-hide",e.ExtendPageShare="$extend-page-share",e.ExtendPageFavorite="$extend-page-favorite"}(w||(w={}));var P=w,O=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));class S{constructor(){this.types=P,this.EventType=c,this.ProfileType=d,this.UtmType=l,this.SdkHook=P,this.inited=!1,this.sended=!1,this.pluginInstances=[],this.data=new Map,this.ready=!1,this.sessionId="",this.env=new b(this),this.option=new y,this.hook=new v,S.instances.push(this);try{this.adapter=new k(this),this.adapter.setLog(S._log),this.adapter.setRequest(S._request),this.adapter.setStorage(S._storage),this.adapter.check(),S.plugins.reduce(((e,t)=>{const{plugin:s}=t;return e.push(new s),e}),this.pluginInstances)}catch(e){}}on(e,t){var s;null===(s=this.hook)||void 0===s?void 0:s.on(e,t)}once(e,t){var s;null===(s=this.hook)||void 0===s?void 0:s.once(e,t)}off(e,t){var s;if(!t&&this.types[e])return;null===(s=this.hook)||void 0===s?void 0:s.off(e,t)}emit(e,t){var s;this.adapter.log(`emit ${e}`,t||""),null===(s=this.hook)||void 0===s||s.emit(e,t)}static useAdapterLog(e){S._log=e}static useAdapterRequest(e){S._request=e}static useAdapterStorage(e){S._storage=e}static usePlugin(e,t){const s=t||e.pluginName;if(s){let t=!1;for(let i=0,r=S.plugins.length;i<r;i++){if(S.plugins[i].name===s){S.plugins[i].plugin=e,t=!0;break}}t||S.plugins.push({name:s,plugin:e})}else S.plugins.push({plugin:e});if("function"==typeof e.init)try{e.init(S)}catch(e){}}get appId(){return this._appId}checkUsePlugin(e){return!!S.plugins.find((({name:t})=>t===e))}init(e){if(this.inited||!f(e))return;const{app_id:t,log:s}=e,i=h(e,["app_id","log"]);if(void 0!==s&&this.option.set({log:s}),!(g(t)&&t>0))return this.adapter.log("app_id invalid"),void 0;this._appId=t,this.option.set(i),this.env.set({app_id:t}),Promise.all([new Promise((e=>{this.once(P.TokenComplete,(()=>{e(!0)}))})),new Promise((e=>{this.checkUsePlugin("official:auto")?this.on(P.LaunchComplete,(()=>{e(!0)})):e(!0)})),new Promise((e=>{this.sended?e(!0):this.once(P.Send,(()=>{e(!0)}))}))]).then((()=>{this.ready=!0,this.emit(P.Ready)}));const r=this.option.get();if(this.pluginInstances.forEach((e=>{e.apply(this,r)})),this.get("is-crawler"))return;this.inited=!0,this.emit(P.Init),this.sessionId=O(),this.on(P.AppShowStart,(()=>{this.sessionId=O()}))}config(e){if(!this.inited||!f(e))return;this.emit(P.Config,e);const{web_id:t,user_unique_id:s}=e,i=h(e,["web_id","user_unique_id"]);void 0!==t&&this.emit(P.ConfigWebId,t),void 0!==s&&this.emit(P.ConfigUuid,s),this.env.set(i)}send(){if(!this.inited||this.sended)return;this.sended=!0,this.emit(P.Send)}event(e,t){if(this.get("is-crawler"))return;if(Array.isArray(e)){const t=_(),s=[];e.forEach((e=>{let i,r,n;if(Array.isArray(e)?[i,r,n]=e:f(e)&&(i=e.event,r=e.params,n=e.local_time_ms),!i)return;(!g(n)||n<0||n>t)&&(n=t),s.push(this.createEvent({event:i,params:r,time:n}))})),s.length>0&&this.emit(P.Event,s)}else this.emit(P.Event,this.createEvent({event:e,params:t}))}createEvent(e,t=!0){const s=Object.assign({event:e.event,params:e.params||{},local_time_ms:e.time||_()},this.sessionId?{session_id:this.sessionId}:{});if(!t)return s;let i="";const r=this.get("ab_sdk_version");r&&(i+=r);const n=this.get("ab_sdk_version_external");return n&&(i?i+=","+n:i=n),Object.assign(Object.assign({},s),i?{ab_sdk_version:i}:{})}set(e,t){this.data.set(e,t)}get(e){return this.data.get(e)}getKey(e){const t=this.appId;if("ab_version"===e||"ab_version_external"===e)return`__tea_sdk_${e}_${t}`;const s={token:"tokens",report:"reports",event:"events",utm:"utm",first:"first",compensate:"compensate"};return s[e]?`__tea_cache_${s[e]}_${t}`:void 0}getUrl(e){const{option:t,env:s}=this,i=s.get("_sdk_version"),r=(s.get("_sdk_name")||"").replace(/@.+\//,""),n=`${t.get("domain")}${e}?sdk_version=${i}&sdk_name=${r}`,o=t.get("caller");if(o)return`${n}&app_id=${this.appId}&caller=${o}`;return n}getToken(e){if(e)return this.emit(P.TokenGet,{callback:e}),void 0;return new Promise((e=>{this.emit(P.TokenGet,{callback:t=>{e(t)}})}))}getConfig(e){return this.env.get(e||"header")}stash(e,t={}){const s="stash";this.set(s,[...this.get(s)||[],this.createEvent({event:e,params:t})])}commit(){const e="stash",t=this.get(e)||[];t.length>0&&(this.event(t),this.set(e,[]))}getVar(e,t,s){if(s)return this.emit(P.AbVar,{name:e,defaultValue:t,callback:s}),void 0;return new Promise((s=>{this.emit(P.AbVar,{name:e,defaultValue:t,callback:e=>{s(e)}})}))}getAllVars(e){if(e)return this.emit(P.AbAllVars,e),void 0;return new Promise((e=>{this.emit(P.AbAllVars,(t=>{e(t)}))}))}getAbSdkVersion(){const e=this.get("ab_versions")||[];return e.length>0?e[e.length-1].ab:""}onAbSdkVersionChange(e){return this.emit(P.AbVersionChangeOn,e),()=>{this.emit(P.AbVersionChangeOff,e)}}offAbSdkVersionChange(e){this.emit(P.AbVersionChangeOff,e)}setExternalAbVersion(e){this.emit(P.AbExternalVersion,"string"==typeof e&&e?`${e}`.trim():null)}getAbConfig(e,t){if(t)return this.emit(P.AbRefresh,{params:e,callback:t}),void 0;return new Promise((t=>{this.emit(P.AbRefresh,{params:e,callback:e=>{t(e)}})}))}profileSet(e){this.emit(P.ProfileSet,e)}profileSetOnce(e){this.emit(P.ProfileSetOnce,e)}profileUnset(e){this.emit(P.ProfileUnset,e)}profileIncrement(e){this.emit(P.ProfileIncrement,e)}profileAppend(e){this.emit(P.ProfileAppend,e)}autoInitializationRangers(e){const{onTokenReady:t}=e,s=h(e,["onTokenReady"]);return this.init(Object.assign(Object.assign({},s),{log:!1,enable_third:!0})),this.send(),this.getToken().then((e=>{const{web_id:s}=e;try{if("function"==typeof t)return t(`${s}`),void 0}catch(e){}return`${s}`}))}}S.plugins=[],S.instances=[];class A{apply(e,t){e.env.set({sdk_version:"2.1.2",_sdk_version:"2.1.2",_sdk_name:"@datarangers/sdk-mp"})}}var C;A.pluginName="official:info",function(e){e.Default="default",e.Custom="custom"}(C||(C={}));class ${constructor(e,t){this.wrap=e,this.sdk=t,this.url="/webid/"}storageNoData(){this.fetch()}storageHasData(e){return this.wrap.dataComplete(e)}fetch(){const{adapter:e,appId:t}=this.sdk;e.request({url:this.sdk.getUrl(`${this.url}`),method:"POST",data:{app_id:t,url:"-",user_agent:"-",referer:"-",user_unique_id:""}}).then((t=>{try{const{data:{e:s=-1e4,web_id:i=""}={}}=t;if(0===s)return this.fetchComplete(i),void 0;e.log("parse web_id error",s)}catch(t){e.log("parse web_id error",t)}this.fetchComplete()})).catch((t=>{this.fetchComplete(),e.log("fetch web_id error",t)}))}fetchComplete(e){if(!e)return;this.wrap.webIdComplete(e)}storageComplete(e){if(!e)return this.storageNoData(),void 0;try{if(e[this.wrap.typeKey]===C.Default){const t=this.storageHasData(e);this.wrap.complete(t)}else this.storageNoData()}catch(e){}}}class I{constructor(e,t){this.wrap=e,this.sdk=t,this.sdk.on(this.sdk.types.ConfigWebId,(e=>{e=`${e}`,this.wrap.tokenComplete?this.waitComplete(e):this.waitResolve?this.waitResolve(e):this.tmpWebId=e}))}storageNoData(){this.wait()}storageHasData(e){return this.wrap.dataComplete(e,this.tmpWebId)}wait(){new Promise((e=>{void 0!==this.tmpWebId?(e(this.tmpWebId),this.tmpWebId=void 0):this.waitResolve=e})).then((e=>{this.waitComplete(e)}))}waitComplete(e){this.wrap.webIdComplete(e)}storageComplete(e){if(!e)return this.storageNoData(),void 0;try{if(e[this.wrap.typeKey]===C.Custom){const t=this.storageHasData(e);this.wrap.complete(t)}else this.storageNoData()}catch(e){}}}class x{constructor(){this.tokenComplete=!1,this.tobid="",this.tobidUrl="/tobid/",this.tobidKey="",this.isCustom=!1,this.typeKey="_type_"}apply(e,t){this.sdk=e,this.options=t,this.key=this.sdk.getKey("token"),this.tobidKey="diss".split("").reverse().join(""),this.options.enable_custom_webid?(this.isCustom=!0,this.token=new I(this,this.sdk)):(this.isCustom=!1,this.token=new $(this,this.sdk));const{types:s}=this.sdk;this.sdk.on(s.ConfigUuid,(e=>{this.setUserUniqueId(e)})),this.sdk.on(s.TokenGet,(({callback:e})=>{const t=()=>{this.fetchTobid().then((()=>{const t=this.sdk.env.get("user"),s=Object.assign(Object.assign({},t),{web_id:this.webId,user_unique_id:this.userUniqueId});s[this.tobidKey]=this.tobid,"function"==typeof e&&e(s)}))};this.sdk.ready?t():this.sdk.once(s.Ready,(()=>{t()}))})),this.storage()}storage(){const{adapter:e}=this.sdk;e.get(this.key).then((t=>{if(!f(t)||!t.web_id)return this.storageComplete(null),void 0;t[this.typeKey]&&!t[this.tobidKey]&&t.user_unique_id||(t={web_id:t.web_id,user_unique_id:t.user_unique_id||t.web_id},e.set(this.key,t)),this.storageComplete(t)})).catch((t=>{this.storageComplete(null),e.log("get token error",t)}))}storageComplete(e){this.token.storageComplete(e)}dataComplete(e,t){let s=e.web_id;void 0!==t&&t!==s&&(s=t),this.webId=s;let i=e.web_id===e.user_unique_id?s:e.user_unique_id;return void 0!==this.tmpUserUniqueId&&this.tmpUserUniqueId!==i&&(i=this.tmpUserUniqueId?this.tmpUserUniqueId:s,this.tmpUserUniqueId=void 0),this.userUniqueId=i,s!==e.web_id||i!==e.user_unique_id}webIdComplete(e){this.webId=e,this.tmpUserUniqueId?(this.userUniqueId=this.tmpUserUniqueId,this.tmpUserUniqueId=void 0):this.userUniqueId=e,this.complete(!0)}complete(e=!1){const{types:t}=this.sdk,s={web_id:this.webId,user_unique_id:this.userUniqueId};this.sdk.env.set(s),s[this.typeKey]=this.isCustom?C.Custom:C.Default,e&&this.sdk.adapter.set(this.key,s),this.tokenComplete=!0,this.sdk.emit(t.TokenComplete)}setUserUniqueId(e){const{adapter:t,env:s,types:i}=this.sdk;if(this.tokenComplete){if(this.userUniqueId===e)return;this.sdk.emit(i.UuidChangeBefore),this.userUniqueId=e||this.webId,s.set({user_unique_id:this.userUniqueId});const r={web_id:this.webId,user_unique_id:this.userUniqueId,[this.typeKey]:this.isCustom?C.Custom:C.Default};t.set(this.key,r),this.sdk.emit(i.UuidChangeAfter)}else this.tmpUserUniqueId=e}fetchTobid(){const{adapter:e,appId:t}=this.sdk;return e.request({url:this.sdk.getUrl(`${this.tobidUrl}`),method:"POST",data:{app_id:t,web_id:this.webId,user_unique_id:this.userUniqueId}}).then((e=>{try{const{data:{e:t=-1e4,tobid:s=""}={}}=e;if(0===t)return this.tobid=s,void 0}catch(e){}})).catch((t=>{e.log("fetch tobid error",t)}))}}x.pluginName="official:token";class q{constructor(){this.url="/list/",this.cache=[]}apply(e,t){this.sdk=e,this.options=t,this.key=this.sdk.getKey("report"),this.reportUrl=this.sdk.getUrl(`${this.url}`),this.sdk.set("report_url",this.reportUrl);const{types:s}=this.sdk;this.sdk.on(s.Report,(e=>{if(Array.isArray(e)||(e=[e]),!this.sdk.ready)return e.forEach((e=>this.cache.push(e))),void 0;this.report(e)})),this.sdk.on(s.Ready,(()=>{this.cache.length>0&&(this.report([...this.cache]),this.cache.length=0)}));const{adapter:i}=this.sdk;this.sdk.on(s.AppOpen,(()=>{i.get(this.key).then((()=>{}))})),this.sdk.on(s.AppClose,(()=>{this.cache.length>0&&(i.set(this.key,[...this.cache]),this.cache.length=0)}))}report(e){this.submit(e)}submit(e){const{types:t}=this.sdk;this.sdk.emit(t.SubmitBefore,e),this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:e}).then((s=>{this.sdk.emit(t.SubmitAfter,{isError:!1,response:s,event:e})})).catch((s=>{this.sdk.emit(t.SubmitAfter,{isError:!0,error:s,event:e}),this.sdk.emit(t.SubmitError,{event:e})}))}}q.pluginName="official:report";class U{constructor(){this.buffer=[],this.timer=0,this.unReadyCache=[]}apply(e,t){var s,i;this.sdk=e,this.options=t,this.enable=!!this.options.enable_buffer;const r=!0===this.options.enable_storage||!1===this.options.disable_storage;if(r&&(this.enable=!0),this.enable){this.interval=this.options.buffer_interval,this.number=this.options.buffer_number,r&&((null===(s=this.options)||void 0===s?void 0:s.report_interval)>0&&(this.interval=this.options.report_interval),(null===(i=this.options)||void 0===i?void 0:i.max_batch_event)>0&&(this.number=this.options.max_batch_event));try{this.interval=Number(this.interval),this.number=Number(this.number)}catch(e){}}this.sdk.set("enable_storage",this.enable);const{types:n}=this.sdk;this.sdk.on(n.Event,(e=>{if(!this.sdk.ready)return this.unReadyCache=[...this.unReadyCache,...Array.isArray(e)?e:[e]],void 0;this.process(Array.isArray(e)?e:[e])})),this.sdk.on(n.Ready,(()=>{this.unReadyCache.length>0&&(this.process(this.unReadyCache),this.unReadyCache=[])})),this.sdk.on(n.AppClose,(()=>{this.buffer.length>0&&(this.report(this.buffer),this.buffer.length=0)}))}process(e){const t=this.sdk.env.compose(e);if(!this.enable)return this.report(t),void 0;this.buffer=[...this.buffer,t],this.refresh()}refresh(){this.timer&&clearTimeout(this.timer),this.buffer.length>=this.number?(this.report([...this.buffer]),this.buffer.length=0):this.timer=setTimeout((()=>{this.report([...this.buffer]),this.buffer.length=0}),this.interval)}report(e){this.sdk.emit(this.sdk.types.Report,e)}}U.pluginName="official:buffer";class E{apply(e,t){this.sdk=e,this.options=t;const{types:s,env:i}=this.sdk,r=(()=>{try{const e=(new Date).getTimezoneOffset();return{timezone:Math.floor(Math.abs(e)/60),offset:60*e}}catch(e){return{timezone:8,offset:-28800}}})();i.set({timezone:r.timezone,tz_offset:r.offset}),this.sdk.on(s.ConfigTransform,(e=>{void 0!==e.gender&&([1,2,"1","2"].includes(e.gender)?e.gender=e.gender<2?"male":"female":delete e.gender);if(!!this.options.enable_profile){const t={};["nick_name","gender","avatar_url"].forEach((s=>{void 0!==e[s]&&(t[s]=e[s],delete e[s])})),this.sdk.emit(s.ProfileSet,t)}})),this.sdk.on(s.EnvTransform,(e=>{if(!!this.options.enable_profile){const t={};["$mp_from_uuid"].forEach((s=>{void 0!==e[s]&&(t[s]=e[s],delete e[s])})),Object.keys(t).length>0&&this.sdk.emit(s.ProfileSetOnce,t)}}))}}E.pluginName="official:transform";class j{constructor(){this.url="/profile/list",this.lastId=0,this.lastOnceId=0,this.duration=6e4,this.cache={},this.buffer=[]}apply(e,t){this.sdk=e,this.options=t;const{types:s}=this.sdk;this.sdk.on(s.ProfileSet,(e=>{this.check()&&this.setProfile(e)})),this.sdk.on(s.ProfileSetOnce,(e=>{this.check()&&this.setOnceProfile(e)})),this.sdk.on(s.ProfileUnset,(e=>{this.check()&&this.unsetProfile(e)})),this.sdk.on(s.ProfileIncrement,(e=>{this.check()&&this.incrementProfile(e)})),this.sdk.on(s.ProfileAppend,(e=>{this.check()&&this.appendProfile(e)})),this.sdk.on(s.ProfileClear,(()=>{this.cache={}})),this.sdk.on(s.Ready,(()=>{if(!this.buffer.length)return;this.reportMore([...this.buffer]),this.buffer=[]}))}check(){return!!this.options.enable_profile}setProfile(e){const t=this.debounce(e);if(!t)return;this.putCache(t);const s=this.filter(t,(e=>this.isString(e)||this.isNumber(e)||this.isArray(e)));this.report(this.sdk.createEvent({event:"__profile_set",params:s}))}setOnceProfile(e){const t=this.debounce(e,!0);if(!t)return;this.putCache(t);const s=this.filter(t,(e=>this.isString(e)||this.isNumber(e)||this.isArray(e)));this.report(this.sdk.createEvent({event:"__profile_set_once",params:s}))}incrementProfile(e){if(!e)return;const t=this.filter(e,(e=>this.isNumber(e)));this.report(this.sdk.createEvent({event:"__profile_increment",params:t}))}unsetProfile(e){if(!e||!this.isString(e))return;const t={};t[e]="1",this.report(this.sdk.createEvent({event:"__profile_unset",params:t}))}appendProfile(e){if(!e||!this.isObject(e)||this.isEmpty(e))return;const t=this.filter(e,(e=>this.isString(e)||this.isArray(e)));this.report(this.sdk.createEvent({event:"__profile_append",params:t}))}reportMore(e){if(this.sdk.ready){const t=this.sdk.env.merge(e,this.sdk.ProfileType),{adapter:s,option:i}=this.sdk;s.request({url:`${i.get("domain")}${this.url}`,method:"POST",data:t}).then((e=>{this.sdk.emit(this.sdk.types.ProfileSubmitAfter,{isError:!0,response:e,event:t})})).catch((e=>{this.sdk.emit(this.sdk.types.ProfileSubmitError,{isError:!0,error:e,event:t})}))}else e.forEach((e=>{this.buffer.push(e)}))}report(e){this.reportMore([e])}ms(){return _()}debounce(e,t=!1){if(!e||!this.isObject(e)||this.isEmpty(e))return;let s=Object.keys(e);const i=this.ms(),r=s.filter((s=>{const r=this.cache[s];if(r&&(t||this.compare(r.val,e[s])&&i-r.timestamp<this.duration))return!1;return!0})).reduce(((t,s)=>(t[s]=e[s],t)),{});if(s=Object.keys(r),!s.length)return;return r}putCache(e){const t=this.ms();Object.keys(e).forEach((s=>{this.cache[s]={val:this.clone(e[s]),timestamp:t}}))}clone(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return e}}compare(e,t){return JSON.stringify(e)===JSON.stringify(t)}filter(e,t){return Object.keys(e).reduce(((s,i)=>{const r=e[i];return t(r)&&(s[i]=r),s}),{})}isObject(e){return f(e)}isArray(e){return(e=>"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e))(e)}isNumber(e){return g(e)}isString(e){return(e=>"string"==typeof e)(e)}isEmpty(e){return!Object.keys(e).length}}function T(e){let t=0,s=0;const i=(e+="").length;for(let r=0;r<i;r++)t=31*t+e.charCodeAt(s++),(t>0x7fffffffffff||t<-0x800000000000)&&(t&=0xffffffffffff);return t<0&&(t+=0x7ffffffffffff),t}j.pluginName="official:profile";S.usePlugin(A),S.usePlugin(x),S.usePlugin(q),S.usePlugin(U),S.usePlugin(E),S.usePlugin(j);class N extends S{appLaunch(){this.appShow()}appTerminate(){this.appHide()}appShow(){let e;void 0!==this.target.getLaunchOptionsSync&&(e=this.target.getLaunchOptionsSync()),this.emit(this.types.AppShow,e)}appHide(){this.emit(this.types.AppHide)}appError(e){this.emit(this.types.AppError,e)}predefinePageview(){this.emit(this.types.PageShow)}predefinePageviewHide(){this.emit(this.types.PageHide)}shareAppMessage(e){try{const t=this.pluginInstances.find((e=>"official:auto"===e.constructor.pluginName));if(t&&"function"==typeof t.pageShare)return t.pageShare(e)}catch(e){}return e}setWebIDviaUnionID(e){if(!e||!this.option.get("enable_custom_webid"))return;const t=T(String(e).trim());this.config({web_id:t,wechat_unionid:e})}setWebIDviaOpenID(e){if(!e||!this.option.get("enable_custom_webid"))return;const t=T(String(e).trim());this.config({web_id:t,wechat_openid:e})}createWebViewUrl(e){if(!e||!this.ready)return e;const t=this.env.get("web_id");if(!t)return e;return this.processWebViewUrl(e,t)}createWebViewUrlAsync(e){if(!e)return Promise.resolve(e);return this.ready?Promise.resolve(this.processWebViewUrl(e,this.env.get("web_id"))):new Promise((t=>{this.on(this.types.Ready,(()=>{t(this.processWebViewUrl(e,this.env.get("web_id")))}))}))}processWebViewUrl(e,t){e=(e=>{let t=e;try{t=decodeURIComponent(e)}catch(e){}return t})(e);const s=/([^?#]+)(\?[^#]*)?(#.*)?/.exec(e),i=s[1]||"",r=s[2]||"",n=s[3]||"",o=r?(e=>{const t={};return e&&e.split("&").forEach((e=>{if(e){const s=e.split("=");s[0]&&(t[s[0]]=s[1]||"")}})),t})(r.substring(1)):{};return o.Web_ID=t,e=i+((e,t)=>{let s=e;if(t){const e=[];Object.keys(t).forEach((s=>{e.push(`${s}=${t[s]}`)})),e.length>0&&(s+=`?${e.join("&")}`)}return s})("",o)+n,e}}var R=console;let V="undefined";const D=()=>{if("undefined"!==V)return V;return V="undefined"!=typeof tt?{target:tt,config:"undefined"!=typeof __ttConfig?__ttConfig:null,customPlatform:"ttMiniProduct",mpPlatform:2,is:"tt"}:"undefined"!=typeof my?{target:my,config:null,customPlatform:"aliMiniProduct",mpPlatform:1,is:"my"}:"undefined"!=typeof swan?{target:swan,config:null,customPlatform:"swanMiniProduct",mpPlatform:5,is:"swan"}:"undefined"!=typeof qq?{target:qq,config:"undefined"!=typeof __qqConfig?__qqConfig:null,customPlatform:"qqMiniProduct",mpPlatform:6,is:"qq"}:"undefined"!=typeof wx?{target:wx,config:"undefined"!=typeof __wxConfig?__wxConfig:null,customPlatform:"miniProduct",mpPlatform:0,is:"wx"}:"undefined"!=typeof uni?{target:uni,config:null,customPlatform:"uniMiniProduct",mpPlatform:7,is:"uni"}:{target:{},config:null,customPlatform:"",mpPlatform:-1,is:""},V},W=D();var H="my"===W.is?e=>t=>{const s=t.timeout||e.option.get("request_timeout"),i="number"==typeof s&&s>0;return new Promise(((e,r)=>{const n=my[my.request?"request":"httpRequest"](Object.assign(Object.assign({},t),{dataType:t.dataType||"json",success:t=>{e(t)},fail:e=>{r(e)}}));i&&setTimeout((()=>{try{n&&n.abort()}catch(e){}}),s)}))}:W.target?((e,t=!1)=>s=>i=>{const r=i.timeout||s.option.get("request_timeout"),n="number"==typeof r&&r>0;return new Promise(((s,o)=>{const a=e.request(Object.assign(Object.assign(Object.assign({},i),n&&!t?{timeout:r}:{}),{dataType:i.dataType||"json",success:e=>{s(e)},fail:e=>{o(e)}}));n&&t&&setTimeout((()=>{try{a&&a.abort()}catch(e){}}),r)}))})(W.target,"swan"===W.is):e=>e=>Promise.reject("request adapter error");const M=D();var K="my"===M.is?new class{get(e){return new Promise(((t,s)=>{try{t(my.getStorageSync({key:e}).data)}catch(e){s(e)}}))}set(e,t){return new Promise(((s,i)=>{try{my.setStorageSync({key:e,data:t}),s(!0)}catch(e){i(!1)}}))}remove(e){return new Promise(((t,s)=>{try{my.removeStorageSync({key:e}),t(!0)}catch(e){s(!1)}}))}}:M.target?new class{constructor(e){this.target=e}get(e){return new Promise(((t,s)=>{try{t(this.target.getStorageSync(e))}catch(e){s(e)}}))}set(e,t){return new Promise(((s,i)=>{try{this.target.setStorageSync(e,t),s(!0)}catch(e){i(!1)}}))}remove(e){return new Promise(((t,s)=>{try{this.target.removeStorageSync(e),t(!0)}catch(e){s(!1)}}))}}(M.target):(()=>{const e="storage adapter error";return{get:t=>Promise.reject(e),set:(t,s)=>Promise.reject(e),remove:t=>Promise.reject(e)}})();class L{apply(e,t){this.sdk=e,this.options=t,this.boost();const{types:s}=this.sdk;this.getInfo(),this.sdk.on(s.AppOpen,(()=>{this.getInfo()}))}boost(){}getInfo(){const e=this,{target:t,env:s}=this.sdk;t&&(t.getSystemInfo&&t.getSystemInfo({success(t){const i={device_brand:t.brand,device_model:t.model,os_version:t.system,os_name:t.platform,platform:t.platform,resolution:`${t.screenWidth}x${t.screenHeight}`,screen_width:t.screenWidth,screen_height:t.screenHeight};e.overlap(t,i),s.set(i)}}),t.getNetworkType&&t.getNetworkType({success(e){const t={access:e.networkType};s.set(t)}}))}overlap(e,t){t.language=e.language,t.mp_platform_app_version=e.version,t.mp_platform_basic_version=e.SDKVersion}}L.pluginName="official:device";N.useAdapterLog(R),N.useAdapterRequest(H),N.useAdapterStorage(K),N.usePlugin(class extends L{static init(e){const t=D();e.platform=t.is?t.target:null,e.platformIs=t.is}boost(){super.boost(),this.which=D(),this.sdk.target=this.which.target,this.sdk.targetEnvConfig=this.which.config,this.sdk.env.set({sdk_lib:"mp_common",custom_platform:this.which.customPlatform,mp_platform:this.which.mpPlatform})}overlap(e,t){super.overlap(e,t)}}),N.usePlugin(e),N.usePlugin(t),N.usePlugin(s),N.usePlugin(i),N.usePlugin(r),N.usePlugin(n),N.usePlugin(o),N.usePlugin(a);export{N as default};
