!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).$$LOGSDK_PLUGIN_AB={})}(this,(function(t){"use strict";function e(t,e){for(var n=0;n<e.length;n++){var s=e[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function n(t){return function(t){if(Array.isArray(t))return s(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return s(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return s(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,s=new Array(e);n<e;n++)s[n]=t[n];return s}function i(t,e){var n={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(n[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(s=Object.getOwnPropertySymbols(t);i<s.length;i++)e.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(t,s[i])&&(n[s[i]]=t[s[i]])}return n}var a=function(){return+new Date},r={cn:"https://abtest.volceapplog.com",va:"https://toblog.itobsnssdk.com",sg:"https://toblog.tobsnssdk.com"},o=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.expire=2592e6,this.domains=r,this.url="/service/2/abtest_config/",this.message={cb:"回调函数必须为一个函数",var:"变量名不能为空",value:"变量没有默认值"},this.fetchStatus=0,this.callbacks=[],this.data=null,this.versions=[],this.externalVersions=null,this.hasOn=!1,this.onHandler=function(){},this.changeListener=new Map,this.exposureName="abtest_exposure",this.clear=!1}var s,o,c;return s=t,o=[{key:"apply",value:function(t,e){var n=this;this.sdk=t,this.options=e;var s=this.sdk,i=s.adapter,r=s.types,o=s.appId;if(this.appId=o,this.externalKey=this.sdk.getKey("ab_version_external"),this.sdk.on(r.AbExternalVersion,(function(t){n.processExternal(t);var e=n.sdk.adapter;t?e.set(n.externalKey,t):e.remove(n.externalKey)})),i.get(this.externalKey).then((function(t){if(!t)return;try{n.processExternal(t)}catch(t){}})),!this.options.enable_ab_test)return;this.dataKey=this.sdk.getKey("ab_version"),this.clear=this.options.clear_ab_cache_on_user_change,this.domain=this.getDomain(),this.sdk.on(r.UuidChangeAfter,(function(){if(!n.sdk.ready)return;n.clear&&(n.versions=[],n.data={},n.updateVersions(),n.emitChange())})),this.sdk.once(r.Ready,(function(){n.preFetch(),n.sdk.on(r.UuidChangeAfter,(function(){n.preFetch()}))})),this.sdk.on(r.AbVar,(function(t){var e=t.name,s=t.defaultValue,i=t.callback;n.getVar(e,s,i)})),this.sdk.on(r.AbAllVars,(function(t){n.getAllVars(t)})),this.sdk.on(r.AbVersionChangeOn,(function(t){n.changeListener.set(t,t)})),this.sdk.on(r.AbVersionChangeOff,(function(t){n.changeListener.get(t)&&n.changeListener.delete(t)})),this.sdk.on(r.AbRefresh,(function(t){var e=t.params,s=t.callback;n.preFetch(e,s)})),i.get(this.dataKey).then((function(t){if(!t)return;var e=t.timestamp;if(a()-e>=n.expire)return n.sdk.adapter.remove(n.dataKey),void 0;try{var s=t.ab_version,i=t.data;2!==n.fetchStatus&&(n.versions=s||[],n.data=i,n.configVersions())}catch(t){}}))}},{key:"output",value:function(t){this.sdk.adapter.log(t)}},{key:"processExternal",value:function(t){this.externalVersions=t,this.sdk.set("ab_sdk_version_external",t)}},{key:"getAllVars",value:function(t){if("function"!=typeof t)return this.output(this.message.cb);var e={callback:t,type:1};2===this.fetchStatus?this._getAllVars(e):this.callbacks.push(e)}},{key:"getVar",value:function(t,e,n){if(!t)return this.output(this.message.var);if(void 0===e)return this.output(this.message.value);if("function"!=typeof n)return this.output(this.message.cb);var s={name:t,defaultValue:e,callback:function(t){try{n(t)}catch(t){}},type:0};2===this.fetchStatus?this._getVar(s):this.callbacks.push(s)}},{key:"fetchComplete",value:function(t){var e=this;if(t){this.data=t;var n=[];Object.keys(t).forEach((function(e){var s=t[e].vid;s&&n.push(s)}));var s=this.versions.length;s?(this.versions=this.versions.filter((function(t){return n.includes(t)})),this.versions.length!==s&&this.updateVersions()):this.updateVersions()}this.callbacks.forEach((function(t){return e[0===t.type?"_getVar":"_getAllVars"](t)})),this.callbacks=[]}},{key:"_getAllVars",value:function(t){(0,t.callback)(this.data?JSON.parse(JSON.stringify(this.data)):{})}},{key:"_getVar",value:function(t){var e,n=t.name,s=t.defaultValue,i=t.callback,a=this.data;if(!a)return i(s),void 0;if(null!=(e=a[n])&&"[object Object]"==Object.prototype.toString.call(e)){var r=a[n],o=r.vid,c=r.val;return o&&(this.versions.includes(o)||(this.versions.push(o),this.updateVersions(),this.emitChange()),this.sdk.emit(this.sdk.types.Event,Object.assign(Object.assign({},this.sdk.createEvent({event:this.exposureName},!1)),{ab_sdk_version:o}))),i(c),void 0}i(s)}},{key:"updateVersions",value:function(){this.configVersions(),this.sdk.adapter.set(this.dataKey,{data:this.data,ab_version:this.versions,timestamp:a()})}},{key:"configVersions",value:function(){var t=this.versions.join(",");this.sdk.set("ab_sdk_version",t);var e="ab_versions";this.sdk.set(e,[].concat(n(this.sdk.get(e)||[]),[{time:a(),ab:t}]))}},{key:"emitChange",value:function(){var t=this.versions.join(",");this.changeListener.size>0&&this.changeListener.forEach((function(e){"function"==typeof e&&setTimeout((function(){try{e(t)}catch(t){}}),0)}))}},{key:"getDomain",value:function(){var t,e=this.options,n=e.channel_domain,s=e.ab_channel_domain,i=null===(t=this.sdk.option.get("cloneOption"))||void 0===t?void 0:t.report_channel,a="";if(s)a=s;else if(n)a=n;else{var r=this.options.report_channel;Object.keys(this.domains).includes(r)||(r=i),a=this.domains[r]}return a}},{key:"preFetch",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1?arguments[1]:void 0;if(!this.domain)return this.fetchStatus=2,this.fetchComplete(null),e&&e(null),void 0;var n=this.sdk.env,s=n.get(),a=s.user,r=s.header,o=r.headers,c=i(r,["headers"]);this.user=Object.assign({},a),this.fetch(Object.assign(Object.assign(Object.assign({},c),o),t||{})).then((function(t){return e&&e(t)}))}},{key:"fetch",value:function(t){var e=this;this.fetchStatus=1;var n=this.user.user_unique_id;return this.sdk.adapter.request({url:"".concat(this.domain).concat(this.url),method:"POST",data:{header:Object.assign(Object.assign({aid:this.appId},this.user||{}),t||{})}}).then((function(t){var s;if(e.user.user_unique_id!==n)return null;e.fetchStatus=2;var i=null===(s=null==t?void 0:t.data)||void 0===s?void 0:s.data;return e.sdk.emit(e.sdk.types.AbFetchAfter,i),e.fetchComplete(i),i})).catch((function(){return e.fetchStatus=2,e.fetchComplete(null),null}))}}],o&&e(s.prototype,o),c&&e(s,c),Object.defineProperty(s,"prototype",{writable:!1}),s,t}();o.pluginName="official:ab",t.DOMAINS=r,t.default=o,Object.defineProperty(t,"__esModule",{value:!0})}));
