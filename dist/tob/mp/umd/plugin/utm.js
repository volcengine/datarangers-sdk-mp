!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).$$LOGSDK_PLUGIN_UTM=e()}(this,(function(){"use strict";function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var e=function(){return+new Date},n=function(t){var e=t;try{e=decodeURIComponent(t)}catch(t){}return e},i=function(t){var e={};return t&&t.split("&").forEach((function(t){if(t){var n=t.split("=");n[0]&&(e[n[0]]=n[1]||"")}})),e},o=function(){function o(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,o),this.key="utm"}var r,a,s;return r=o,a=[{key:"apply",value:function(t,e){var n=this;this.sdk=t,this.options=e;var i=this.sdk.types;this.sdk.on(i.LaunchInfo,(function(t){var e,i;n.parseDefault(null!==(e=null==t?void 0:t.query)&&void 0!==e?e:{}),n.parseMore(null!==(i=null==t?void 0:t.query)&&void 0!==i?i:{})}))}},{key:"parseDefault",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=!1,o=Object.keys(e).reduce((function(o,r){return t.sdk.UtmType.includes(r)&&(i=!0,o[r]=n(e[r])),o}),{});i&&this.sdk.env.set(o)}},{key:"parseMore",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=e||{},r=o.tr_token,a=void 0===r?"":r,s=o.surl_token,u=void 0===s?"":s,c=o.scene,f=void 0===c?"":c,d=a||u;if(f){var h=i(n("".concat(f)));h.tr_token&&(d=h.tr_token),this.sdk.set("scene_extra_query",h)}if(!d)return this.dispatch(),void 0;this.storageGet(d).then((function(e){e?(t.sdk.env.set(e.utms||{}),t.dispatch()):t.fetch(d).then((function(){return t.dispatch()})).catch((function(){return t.dispatch()}))})).catch((function(){t.fetch(d).then((function(){return t.dispatch()})).catch((function(){return t.dispatch()}))}))}},{key:"storageGet",value:function(t){var n=this.sdk.getKey(this.key),i=this.sdk.adapter;return i.get(n).then((function(o){var r=e(),a=[];if(Object.keys(o).forEach((function(t){o[t]&&o[t].timestamp+864e7<r&&a.push(t)})),a.length>0&&(a.forEach((function(t){delete o[t]})),i.set(n,o)),o&&o[t])return o[t];return null}))}},{key:"storageSet",value:function(t,n){var i=this.sdk.getKey(this.key),o=this.sdk.adapter;o.get(i).then((function(r){r||(r={}),r[t]={utms:n,timestamp:e()},o.set(i,r)}))}},{key:"fetch",value:function(t){var e=this,n=this.sdk,i=n.adapter,o=n.option,r=n.env,a=n.UtmType;return i.request({url:"".concat(o.get("domain"),"/service/2/mp_campaigns"),method:"GET",data:{tr_token:t},timeout:3e3}).then((function(n){var o,s=(n||{}).data,u=(s=void 0===s?{}:s).code,c=void 0===u?-1:u,f=s.data,d=void 0===f?{}:f,h=s.message,l=void 0===h?"":h;if(0===c){if(null!=(o=d)&&"[object Object]"==Object.prototype.toString.call(o)){var p=!1,v=Object.keys(d).reduce((function(t,e){return a.includes(e)&&(p=!0,v[e]=d[e]),t}),{});p&&r.set(v),e.storageSet(t,v)}}else 40002===c&&e.storageSet(t,{});0!==c&&i.log(l||"")}))}},{key:"dispatch",value:function(){this.sdk.emit(this.sdk.types.LaunchComplete)}}],a&&t(r.prototype,a),s&&t(r,s),Object.defineProperty(r,"prototype",{writable:!1}),r,o}();return o.pluginName="official:utm",o}));
