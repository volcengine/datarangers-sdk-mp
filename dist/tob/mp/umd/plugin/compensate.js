!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).$$LOGSDK_PLUGIN_COMPENSATE=e()}(this,(function(){"use strict";function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function e(t){return function(t){if(Array.isArray(t))return r(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return r(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return r(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var n=function(){return+new Date},a=function(){function r(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,r),this.key="compensate",this.cache=new Map,this.batchMax=10,this.enable=!1,this.storageCache=new Map}var a,o,i;return a=r,(o=[{key:"apply",value:function(t,r){var n=this;this.sdk=t,this.options=r,this.reportUrl=this.sdk.get("report_url"),this.enable=this.sdk.get("enable_storage"),this.options.enable_storage_only&&(this.enable=!0);var a=this.sdk.types;this.enable&&this.sdk.on(a.Ready,(function(){n.storageGet().then((function(t){if(!n.reportUrl||!t||!Array.isArray(t))return;var r=function(t){return new Promise((function(e){n.sdk.adapter.request({url:n.reportUrl,method:"POST",data:t}).then((function(){e(null)})).catch((function(){e(null)}))}))};if(t.length>50){var a=e(t);!function t(){var e=a.splice(0,50);e.length>0&&r(e).then((function(){a.length>0&&t()}))}()}else r(t)}))})),this.sdk.on(a.SubmitError,(function(t){var e=n.random(),r=t.event;n.cache.set(e,r),n.process()})),this.sdk.on(a.AppClose,(function(){n.report()}))}},{key:"process",value:function(){this.cache.size>=this.batchMax&&this.report()}},{key:"report",value:function(){var t=this;if(!this.reportUrl&&(this.reportUrl=this.sdk.get("report_url"),!this.reportUrl))return;var r=[];if(this.cache.forEach((function(t){r=[].concat(e(r),e(t))})),r.length>0){var n=this.random();this.enable&&this.storageCache.set(n,r),this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:r}).then((function(){t.enable&&t.storageCache.delete(n)})).catch((function(){if(t.enable){var r=[];t.storageCache.forEach((function(t){r=[].concat(e(r),e(t))})),t.storageSet(r)}})),this.cache=new Map}}},{key:"storageGet",value:function(){var t=this.sdk.getKey(this.key),e=this.sdk.adapter;return e.get(t).then((function(r){if(e.remove(t),null==(a=r)||"[object Object]"!=Object.prototype.toString.call(a)||!r.timestamp)return null;var a,o=n();if(r.timestamp+864e7<o)return null;return r.data}))}},{key:"storageSet",value:function(t){var e=this.sdk.getKey(this.key);this.sdk.adapter.set(e,{data:t,timestamp:n()})}},{key:"random",value:function(){return"".concat(+new Date,"_").concat(Math.floor(1e10*Math.random()))}}])&&t(a.prototype,o),i&&t(a,i),Object.defineProperty(a,"prototype",{writable:!1}),a,r}();return a.pluginName="official:compensate",a}));
