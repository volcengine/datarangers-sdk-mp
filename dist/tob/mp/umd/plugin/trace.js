!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).$$LOGSDK_PLUGIN_TRACE=e()}(this,(function(){"use strict";function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var e,i,n,a="applog_trace";!function(t){t.Mp="mp",t.Quick="quick",t.QG="qg"}(e||(e={})),function(t){t.Launch="launch",t.Terminate="terminate",t.Auto="auto",t.Event="event",t.LogData="log_data",t.Profile="profile"}(i||(i={})),function(t){t.Net="net",t.FailNet="f_net",t.FailData="f_data"}(n||(n={}));var r=function(){function r(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,r),this.maxCount=100,this.platform=e.Mp}var s,o,u;return s=r,o=[{key:"apply",value:function(t,e){var a=this;this.sdk=t,this.options=e,this.aid=this.sdk.appId,this.isAuto=this.options.auto_report,this.isPrivate=!!this.options.channel_domain;var r=this.sdk.types;this.sdk.on(r.SubmitBefore,(function(t){if(a.isPrivate)return;if(a.isTest())return;a.parse(t).forEach((function(t){a.collect(t)}))})),this.sdk.on(r.SubmitAfter,(function(t){if(a.isPrivate)return;if(a.isTest())return;var e=t.isError,r=t.event,s=e?n.FailNet:n.FailData,o=a.parse([{events:r}],s);if(s===n.FailData){var u=t.response.data;a.collect({key:i.Event,state:s},u.sc||o.length)}else o.forEach((function(t){a.collect(t)}))})),this.sdk.on(r.AppClose,(function(){a.commit()}))}},{key:"parse",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.Net,r=[];return t&&t.forEach((function(t){t.events.forEach((function(t){var n=t.event;if(n===a)return;if(e.isTest(t))return;r.push({key:e.getKey(n),state:i})}))})),r}},{key:"collect",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=t.key,r=t.state;this.cache||(this.cache=new Map);var s=this.cache,o=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return{count:t,state:r,key:n,params_for_special:a,platform:e.platform,aid:e.aid,_staging_flag:1}},u=i;if(s.has(n)){var c=s.get(n);if(c.has(r)){var f=c.get(r);f.count+=i,u=f.count}else c.set(r,o(i))}else{var l=new Map;l.set(r,o(i)),s.set(n,l)}u>=this.maxCount&&this.critical(n,r)}},{key:"report",value:function(t){var e=this;if(!this.aid||!t)return;var i=[];t.forEach((function(t){t.forEach((function(t){t.aid||(t.aid=e.aid);var n=e.sdk.createEvent({event:a,params:t});i.push(n)}))})),i.length>0&&this.sdk.event(i)}},{key:"getKey",value:function(t){var e=this.sdk,n=e.EventType,a=e.ProfileType;switch(t){case n.appOnShow:return i.Launch;case n.appOnHide:return i.Terminate;default:if(Object.values(n).includes(t))return i.Auto;if(a.includes(t))return i.Profile;return i.Event}}},{key:"critical",value:function(t,e){this.commit()}},{key:"commit",value:function(){if(this.isPrivate)return;if(this.isTest())return;var t=this.cache;this.cache=null,this.report(t)}},{key:"isTest",value:function(t){var e,i;if(t)return!!(null===(e=JSON.parse(t.params))||void 0===e?void 0:e._staging_flag);return!!(null===(i=this.sdk.env.get("evtParams"))||void 0===i?void 0:i._staging_flag)}}],o&&t(s.prototype,o),u&&t(s,u),Object.defineProperty(s,"prototype",{writable:!1}),s,r}();return r.pluginName="official:trace",r}));
