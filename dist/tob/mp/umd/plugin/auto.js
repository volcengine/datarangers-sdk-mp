!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).$$LOGSDK_PLUGIN_AUTO=e()}(this,(function(){"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function i(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function r(t){return r=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},r(t)}function o(t,e){return o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},o(t,e)}function s(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function a(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=r(t);if(e){var o=r(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return s(this,n)}}function p(t){return function(t){if(Array.isArray(t))return u(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return u(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return u(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function c(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(t);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(t,i[r])&&(n[i[r]]=t[i[r]])}return n}var h,f=function(){return+new Date},l=function(t){return null!=t&&"[object Object]"==Object.prototype.toString.call(t)},d=function(t){var e=t;try{e=decodeURIComponent(t)}catch(t){}return e},y=function(t){var e={};return t&&t.split("&").forEach((function(t){if(t){var n=t.split("=");n[0]&&(e[n[0]]=n[1]||"")}})),e};!function(t){t.True="true",t.False="false"}(h||(h={}));var v=function(){function n(){e(this,n),this.queue=[],this.firstTime=h.False,this.open=!1,this.launched=!1,this.autoConfig={appLaunch:!0,appTerminate:!0,appError:!0,pageShow:!0,pageHide:!0,pageShare:!0,pageFavorite:!0},this.missAppLaunch=!1,this.missAppShow=!1,n.instances.push(this)}return i(n,[{key:"apply",value:function(e,n){var i=this;this.sdk=e,this.options=n,this.open=!!this.options.auto_report,this.open&&"object"===t(this.options.auto_report)&&(this.autoConfig=Object.assign(Object.assign({},this.autoConfig),this.options.auto_report||{})),this.proxySetTitle();var r=this.sdk,o=r.types,s=r.adapter,a=this.sdk.getKey("first");s.get(a).then((function(t){if(t===h.False)return i.firstTime=h.False,void 0;t||(i.firstTime=h.True),s.set(a,h.False)})),this.sdk.on(o.Ready,(function(){i.queue.length>0&&(i.sdk.event(p(i.queue)),i.queue.length=0)})),this.sdk.on(o.AppOpen,(function(t){i.appLaunch(t)})),this.missAppLaunch&&this.appLaunch(this.missAppLaunchInfo),this.sdk.on(o.AppShow,(function(t){i.open&&i.autoConfig.appLaunch&&i.appShow(t)})),this.open&&this.autoConfig.appLaunch&&this.missAppShow&&this.appShow(this.missAppShowInfo),this.sdk.on(o.AppHide,(function(){i.open&&i.autoConfig.appTerminate&&i.appHide()})),this.sdk.on(o.AppError,(function(t){i.open&&i.autoConfig.appError&&i.appError(t)})),this.sdk.on(o.PageShow,(function(){var t=i.getRouteInfo();if(t){var e=t.path,n=t.query;i.sdk.env.set({evtParams:Object.assign({$current_path:e},n?{$current_query:JSON.stringify(n)}:{})})}i.open&&i.autoConfig.pageShow&&i.pageShow()})),this.sdk.on(o.PageHide,(function(){i.open&&i.autoConfig.pageHide&&i.pageHide()})),this.sdk.on(o.UuidChangeBefore,(function(){i.open&&i.autoConfig.appTerminate&&i.appHide()})),this.sdk.on(o.UuidChangeAfter,(function(){i.open&&i.autoConfig.appLaunch&&i.appShow(i.appInfo)}))}},{key:"event",value:function(t,e){this.sdk.ready?this.sdk.event(t,e):this.queue.push({event:t,params:e,local_time_ms:f()})}},{key:"proxySetTitle",value:function(){var t=this.sdk.target;if(!t)return;var e=this;try{var n=function(t){return function(){return function(n){try{var i=getCurrentPages(),r=i[i.length-1].route||"";l(n)||(n={});var o=e.sdk.get("title-caches")||{};o[r]=n.title,e.sdk.set("title-caches",o)}catch(t){}t.call(this,n)}}};if(void 0!==t.setNavigationBarTitle){var i=t.setNavigationBarTitle;Object.defineProperty(t,"setNavigationBarTitle",{get:n(i)})}else if(void 0!==t.setNavigationBar){var r=t.setNavigationBar;Object.defineProperty(t,"setNavigationBar",{get:n(r)})}}catch(t){}}},{key:"getPageTitle",value:function(t){var e=this.sdk.targetEnvConfig,n=this.sdk.get("title-caches"),i="";if(void 0!==(null==n?void 0:n[t])&&(i=n[t]),!i)try{if(e){var r=e.page[t]||e.page[t+".html"];r&&(i=r.window.navigationBarTitleText),i||(i=e.global.window.navigationBarTitleText)}}catch(t){}return i}},{key:"getRouteInfo",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1?arguments[1]:void 0;try{var n=(e=e||getCurrentPages()).length-t;if(n<0)return null;var i=e[n],r=i.route,o=void 0===r?"":r,s=i.options,a=void 0===s?{}:s;return{path:o,query:a}}catch(t){}return null}},{key:"getCurrentPage",value:function(){var t=getCurrentPages()||[];return t[t.length-1]}},{key:"getQuery",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n={};if(l(e)){if(e.scene){var i=y(d("".concat(e.scene)));Object.keys(i).forEach((function(t){n["query_".concat(t)]=i[t]}))}Object.keys(e).forEach((function(i){if(!t.sdk.UtmType.includes(i)&&"scene"!==i){var r=e[i];"from_title"===i&&(r=encodeURIComponent(d(e[i]))),n["query_".concat(i)]=r}}))}return n}},{key:"fixInfo",value:function(t,e){var n=e;if(!e.path)if(e.args)n=e.args;else try{JSON.stringify(e)}catch(t){n={query:{}}}var i={info:n};return this.sdk.emit(this.sdk.types.TransformInfo,{type:t,rawInfo:e,wrapInfo:i}),n=i.info}},{key:"appLaunch",value:function(t){var e,n,i;this.appInfo=t||(null===(n=(e=this.sdk.target).getLaunchOptionsSync)||void 0===n?void 0:n.call(e)),this.appInfo=this.fixInfo("App.onLaunch",this.appInfo),this.scene=null===(i=this.appInfo)||void 0===i?void 0:i.scene,this.sdk.checkUsePlugin("official:utm")?this.sdk.emit(this.sdk.types.LaunchInfo,this.appInfo):this.sdk.emit(this.sdk.types.LaunchComplete)}}],[{key:"init",value:function(t){var e={onLaunch:function(e){t.instances.forEach((function(t){t.emit(t.types.AppOpen,e)})),n.instances.forEach((function(t){t.sdk||(t.missAppLaunch=!0,t.missAppLaunchInfo=e)}))},onShow:function(e){t.instances.forEach((function(t){t.emit(t.types.AppShowStart,e),t.emit(t.types.AppShow,e)})),n.instances.forEach((function(t){t.sdk||(t.missAppShow=!0,t.missAppShowInfo=e)}))},onHide:function(){t.instances.forEach((function(t){t.emit(t.types.AppHide),t.emit(t.types.AppClose)}))},onError:function(e){t.instances.forEach((function(t){t.emit(t.types.AppError,e)}))}},i={onShow:function(){t.instances.forEach((function(t){t.emit(t.types.PageShow)}))},onHide:function(){t.instances.forEach((function(t){t.emit(t.types.PageHide)}))},onUnload:function(){t.instances.forEach((function(t){t.emit(t.types.PageHide)}))},onShareAppMessage:function(t){var e=n.instances.length;if(!e)return t;var i=n.instances[e-1];if(!i.sdk||!i.open||!i.autoConfig.pageShare)return t;return i.pageShare(t)},onAddToFavorites:function(t){if(!n.instances.length)return;n.instances.forEach((function(e){if(!e.sdk||!e.open||!e.autoConfig.pageFavorite)return;e.pageFavorite(t)}))}};if(t.platform&&"swan"===t.platformIs&&App.after&&Page.after)return App.after({methods:Object.assign({},e)}),Page.after({methods:Object.assign({},i)}),void 0;var r=App;App=function(t){return Object.keys(e).forEach((function(n){var i=t[n];t[n]=function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];try{e[n].apply(this,r)}catch(t){}return i&&i.apply(this,r)}})),r(t)};var o=Page;if(Page=function(t){var e=i;return Object.keys(e).forEach((function(n){var i=t[n];"onShareAppMessage"===n?i&&(t[n]=function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];var s=i?i.apply(this,r):{};try{var a=e[n].apply(this,[s]);s.path=a.path}catch(t){}return s}):"onAddToFavorites"===n?i&&(t[n]=function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];var s=i?i.apply(this,r):{};try{e[n].apply(this,[{res:r[0],result:s}])}catch(t){}return s}):t[n]=function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];try{e[n].apply(this,r)}catch(t){}return i&&i.apply(this,r)}})),o(t)},"undefined"!=typeof Component){var s=Component;Component=function(t){t.methods||(t.methods={});var e=i;return Object.keys(e).forEach((function(n){var i=t.methods[n];"onShareAppMessage"===n?i&&(t.methods[n]=function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];var s=i?i.apply(this,r):{};try{var a=e[n].apply(this,[s]);s.path=a.path}catch(t){}return s}):"onAddToFavorites"===n?i&&(t.methods[n]=function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];var s=i?i.apply(this,r):{};try{e[n].apply(this,[{res:r[0],result:s}])}catch(t){}return s}):t.methods[n]=function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];try{e[n].apply(this,r)}catch(t){}return i&&i.apply(this,r)}})),s(t)}}}}]),n}();v.pluginName="official:auto",v.instances=[];var g=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&o(t,e)}(r,t);var n=a(r);function r(){var t;return e(this,r),(t=n.apply(this,arguments)).sessionStart=0,t.sessionDepth=0,t.shareDepth=0,t}return i(r,[{key:"appShow",value:function(t){t=t||this.appInfo,t=this.fixInfo("App.onShow",t);var e=this.sdk.sessionId;this.sessionStart=f();var n=t.query,i=(n=void 0===n?{}:n).share_depth,r=void 0===i?0:i;this.shareDepth=Number(r)||0;var o=this.sdk.EventType,s=t.referrerInfo,a=c(t,["referrerInfo"]),p=a.query,u=c(a,["query"]),l=Object.assign(Object.assign({},p),s),d=Object.assign(Object.assign(Object.assign({session_id:e,$is_first_time:this.firstTime},u),this.scene?{scene:this.scene}:{}),this.getQuery(l));this.sdk.emit(this.sdk.types.ExtendAppLaunch,d),this.event(o.appOnShow,d),this.firstTime===h.True&&(this.firstTime=h.False)}},{key:"appHide",value:function(){var t=this.getCurrentPage(),e=t.route,n=t.__route__,i=t.options,r=void 0===i?{}:i,o=e||n,s=Object.assign(Object.assign({exit_page:o,session_duration:Math.ceil((f()-this.sessionStart)/1e3),session_depth:this.sessionDepth,session_id:this.sdk.sessionId},this.scene?{scene:this.scene}:{}),this.getQuery(r));this.sdk.emit(this.sdk.types.ExtendAppTerminate,s),this.event(this.sdk.EventType.appOnHide,s)}},{key:"appError",value:function(t){var e={on_error:t,session_id:this.sdk.sessionId};this.sdk.emit(this.sdk.types.ExtendAppError,e),this.event(this.sdk.EventType.appOnError,e)}},{key:"pageShow",value:function(){this.sessionDepth+=1;var t=this.getCurrentPage(),e=t.route,n=t.__route__,i=t.options,r=void 0===i?{}:i,o=e||n,s=this.sdk.EventType,a=Object.assign(Object.assign({path:o,title:this.getPageTitle(o),session_id:this.sdk.sessionId},this.scene?{scene:this.scene}:{}),this.getQuery(r)),p=null;if(this.recentlyPage)p=this.recentlyPage;else{var u=this.getRouteInfo(2);u&&(p=u)}if(p){var c=p,h=c.path,l=void 0===h?"":h,d=c.query,y=void 0===d?{}:d;a.refer_path=l,a.refer_query=JSON.stringify(y)}this.sdk.emit(this.sdk.types.ExtendPageShow,a),this.recentlyPage={path:o,query:r},this.currentPvInfo={time:f(),params:Object.assign({},a)},this.event(s.pageOnShow,a)}},{key:"pageHide",value:function(){if(!this.currentPvInfo)return;var t=this.currentPvInfo,e=t.time,n=t.params;this.currentPvInfo=null;var i=f()-e;i=i<0?0:i;var r=Object.assign(Object.assign({},n||{}),{duration:i});this.sdk.emit(this.sdk.types.ExtendPageHide,r),this.event(this.sdk.EventType.pageOnHide,r)}},{key:"pageShare",value:function(t){var e=this.sdk.env.get().user.user_unique_id,n=this.shareDepth+1;if(t.path){var i=t.path,r="",o=i.indexOf("#");-1!==o&&(r=i.substr(o),i=i.substr(0,o));var s="from_user_unique_id=".concat(e,"&share_depth=").concat(n,"&from_title=").concat(t.title);i+="".concat(-1!==i.indexOf("?")?"&":"?").concat(s),t.path=i+r}var a=t.title,p=t.path,u=void 0===p?"":p,c={title:a,path:u,page_path:u.split("?")[0],query_share_depth:n,session_id:this.sdk.sessionId};return this.sdk.emit(this.sdk.types.ExtendPageShare,c),this.event(this.sdk.EventType.pageOnShareAppMessage,c),Object.assign(Object.assign({},t),{share_depth:n})}},{key:"pageFavorite",value:function(t){var e=t||{},n=e.res,i=e.result,r=getCurrentPages(),o=r[r.length-1],s=o.route,a=o.__route__,p=s||a,u=i.query,h=c(i,["query"]),f=Object.assign({url_path:(null==n?void 0:n.webViewUrl)||p,url_query:u},h);this.sdk.emit(this.sdk.types.ExtendPageFavorite,f),this.event(this.sdk.EventType.pageOnAddToFavorites,f)}}]),r}(v);return g}));
